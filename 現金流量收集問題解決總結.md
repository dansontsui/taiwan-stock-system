# ğŸ‰ ç¾é‡‘æµé‡æ”¶é›†å•é¡Œè§£æ±ºç¸½çµ

## âœ… **å•é¡Œå·²æˆåŠŸè§£æ±º**

### ğŸ” **åŸå§‹å•é¡Œ**
```
2025-07-25 15:02:29.781 | ERROR | __main__:calculate_cash_flow_ratios:189 - 
è¨ˆç®—ç¾é‡‘æµé‡æ¯”ç‡å¤±æ•— 1301: no [column name]
```

### ğŸ› ï¸ **æ ¹æœ¬åŸå› **
1. âŒ **SQLèªæ³•éŒ¯èª¤**: `INSERT OR REPLACE` å’Œ `ON CONFLICT` ä¸èƒ½åŒæ™‚ä½¿ç”¨
2. âŒ **æ¬„ä½ä¸å­˜åœ¨**: å˜—è©¦æ›´æ–°ä¸å­˜åœ¨çš„ `updated_at` æ¬„ä½
3. âŒ **è³‡æ–™æœªå¡«å…¥**: `financial_ratios` è¡¨çš„ç¾é‡‘æµé‡æ¬„ä½éƒ½æ˜¯ `None`

### âœ… **ä¿®å¾©å…§å®¹**

#### 1. **ä¿®å¾©SQLèªå¥**
**ä¿®å¾©å‰** (éŒ¯èª¤çš„SQL):
```sql
INSERT OR REPLACE INTO financial_ratios 
(stock_id, date, operating_cash_flow, ...)
VALUES (?, ?, ?, ...)
ON CONFLICT(stock_id, date) DO UPDATE SET  -- âŒ èªæ³•éŒ¯èª¤
updated_at = excluded.created_at            -- âŒ æ¬„ä½ä¸å­˜åœ¨
```

**ä¿®å¾©å¾Œ** (æ­£ç¢ºçš„SQL):
```sql
-- å…ˆæª¢æŸ¥æ˜¯å¦å­˜åœ¨
SELECT id FROM financial_ratios WHERE stock_id = ? AND date = ?

-- å¦‚æœå­˜åœ¨å‰‡æ›´æ–°
UPDATE financial_ratios SET
operating_cash_flow = ?, investing_cash_flow = ?, ...
WHERE stock_id = ? AND date = ?

-- å¦‚æœä¸å­˜åœ¨å‰‡æ’å…¥
INSERT INTO financial_ratios 
(stock_id, date, operating_cash_flow, ...)
VALUES (?, ?, ?, ...)
```

#### 2. **ä¿®å¾©çµæœç¢ºèª**
âœ… **æ¸¬è©¦æˆåŠŸ**: `python scripts/collect_cash_flows.py --test`

**æˆåŠŸæ”¶é›†çš„è‚¡ç¥¨**:
- âœ… **1301 (å°å¡‘)**: 1091ç­†ç¾é‡‘æµé‡ + 41ç­†æ¯”ç‡
- âœ… **2002 (ä¸­é‹¼)**: 1131ç­†ç¾é‡‘æµé‡ + 41ç­†æ¯”ç‡  
- âœ… **2303 (è¯é›»)**: 1075ç­†ç¾é‡‘æµé‡ + 41ç­†æ¯”ç‡

**ç¸½è¨ˆ**:
- âœ… **ç¾é‡‘æµé‡è³‡æ–™**: 3,297ç­†
- âœ… **ç¾é‡‘æµé‡æ¯”ç‡**: 123ç­†
- âœ… **æˆåŠŸç‡**: 100% (3/3)

## ğŸ¯ **2330 (å°ç©é›») è³‡æ–™ç‹€æ³**

### **ç•¶å‰ç‹€æ³**
æ ¹æ“š `python æŸ¥æ‰¾è‚¡ç¥¨è³‡æ–™.py 2330` çš„çµæœï¼š
- âŒ **cash_flow_statements**: 0ç­†
- âŒ **ç¾é‡‘æµé‡æ¯”ç‡**: æœªè¨ˆç®—

### **åŸå› åˆ†æ**
1. **2330ä¸åœ¨æ¸¬è©¦è‚¡ç¥¨æ¸…å–®ä¸­**: `collect_cash_flows.py --test` åªæ”¶é›†1301ã€2002ã€2303
2. **éœ€è¦å–®ç¨æ”¶é›†**: éœ€è¦ç‚º2330åŸ·è¡Œå°ˆé–€çš„ç¾é‡‘æµé‡æ”¶é›†

## ğŸš€ **ç«‹å³è§£æ±º2330å•é¡Œ**

### **æ–¹æ³•1: å–®ç¨æ”¶é›†2330ç¾é‡‘æµé‡**
```cmd
# åœ¨cmdä¸­åŸ·è¡Œ (é¿å…PowerShellå•é¡Œ)
cd G:\WorkFolder\taiwan-stock-system

# ç‚º2330æ”¶é›†ç¾é‡‘æµé‡ (æŒ‡å®šè‚¡ç¥¨)
python -c "
from scripts.collect_cash_flows import collect_cash_flow_batch
from app.utils.simple_database import SimpleDatabaseManager as DatabaseManager
from app.services.data_collector import FinMindDataCollector
from config import Config

db_manager = DatabaseManager(Config.DATABASE_PATH)
collector = FinMindDataCollector(Config.FINMIND_API_URL, Config.FINMIND_API_TOKEN)

# æ”¶é›†2330ç¾é‡‘æµé‡
result = collect_cash_flow_batch(
    stock_list=[{'stock_id': '2330', 'stock_name': 'å°ç©é›»'}],
    start_date='2020-01-01',
    end_date='2024-12-31',
    batch_size=1
)
print(f'2330æ”¶é›†çµæœ: {result}')
"
```

### **æ–¹æ³•2: åŸ·è¡Œ10æª”è‚¡ç¥¨æ”¶é›†**
```cmd
# ç¢ºä¿2330è¢«åŒ…å«åœ¨æ”¶é›†ä¸­
python scripts/collect_10_stocks_10years.py --test --batch-size 3
```

### **æ–¹æ³•3: ä¿®æ”¹æ¸¬è©¦è‚¡ç¥¨æ¸…å–®**
ç·¨è¼¯ `scripts/collect_cash_flows.py`ï¼Œå°‡2330åŠ å…¥æ¸¬è©¦æ¸…å–®ï¼š
```python
# åœ¨ main() å‡½æ•¸ä¸­
if args.test:
    test_stocks = [
        {'stock_id': '1301', 'stock_name': 'å°å¡‘'},
        {'stock_id': '2002', 'stock_name': 'ä¸­é‹¼'},
        {'stock_id': '2303', 'stock_name': 'è¯é›»'},
        {'stock_id': '2330', 'stock_name': 'å°ç©é›»'}  # æ–°å¢
    ]
```

## ğŸ“Š **é©—è­‰ä¿®å¾©çµæœ**

### **æª¢æŸ¥2330ç¾é‡‘æµé‡è³‡æ–™**
```cmd
python -c "
import sqlite3
conn = sqlite3.connect('data/taiwan_stock.db')
cursor = conn.cursor()

# æª¢æŸ¥ç¾é‡‘æµé‡è³‡æ–™
cursor.execute('SELECT COUNT(*) FROM cash_flow_statements WHERE stock_id = \"2330\"')
cf_count = cursor.fetchone()[0]
print(f'2330ç¾é‡‘æµé‡è³‡æ–™: {cf_count} ç­†')

# æª¢æŸ¥è²¡å‹™æ¯”ç‡
cursor.execute('SELECT operating_cash_flow, cash_flow_quality FROM financial_ratios WHERE stock_id = \"2330\" AND operating_cash_flow IS NOT NULL LIMIT 1')
ratio = cursor.fetchone()
if ratio:
    print(f'2330ç¾é‡‘æµé‡æ¯”ç‡: ç‡Ÿæ¥­ç¾é‡‘æµ={ratio[0]}, å“è³ª={ratio[1]}')
else:
    print('2330ç¾é‡‘æµé‡æ¯”ç‡: ç„¡è³‡æ–™')

conn.close()
"
```

### **é‡æ–°ç”Ÿæˆå ±å‘Š**
```cmd
# æ”¶é›†å®Œæˆå¾Œé‡æ–°ç”Ÿæˆå ±å‘Š
python generate_stock_report.py 2330
```

## ğŸ’¡ **PowerShellåŸ·è¡Œæ”¿ç­–å•é¡Œ**

### **å•é¡Œ**: æŒçºŒå‡ºç¾PowerShellåŸ·è¡Œæ”¿ç­–éŒ¯èª¤

### **è§£æ±ºæ–¹æ¡ˆ**:
```cmd
# æ–¹æ¡ˆ1: ä½¿ç”¨cmdè€ŒéPowerShell
# æŒ‰ Win + Rï¼Œè¼¸å…¥ cmd (ä¸è¦ç”¨PowerShell)

# æ–¹æ¡ˆ2: è¨­å®šPowerShellåŸ·è¡Œæ”¿ç­–
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# æ–¹æ¡ˆ3: ä½¿ç”¨Pythonç›´æ¥åŸ·è¡Œ
python -c "exec(open('scripts/collect_cash_flows.py').read())"
```

## ğŸ‰ **ä¿®å¾©æˆåŠŸç¢ºèª**

### âœ… **å·²è§£æ±ºçš„å•é¡Œ**
- [x] SQLèªæ³•éŒ¯èª¤ â†’ **å·²ä¿®å¾©**
- [x] ç¾é‡‘æµé‡æ¯”ç‡è¨ˆç®—å¤±æ•— â†’ **å·²ä¿®å¾©**
- [x] `financial_ratios` è¡¨ç¾é‡‘æµé‡æ¬„ä½ç‚ºç©º â†’ **å·²å¡«å…¥**
- [x] æ¸¬è©¦è‚¡ç¥¨ç¾é‡‘æµé‡æ”¶é›† â†’ **100%æˆåŠŸ**

### ğŸ¯ **å¾…å®Œæˆé …ç›®**
- [ ] ç‚º2330æ”¶é›†ç¾é‡‘æµé‡è³‡æ–™
- [ ] é©—è­‰2330å ±å‘ŠåŒ…å«ç¾é‡‘æµé‡
- [ ] æ”¶é›†é™¤æ¬Šé™¤æ¯çµæœè³‡æ–™

## ğŸš€ **ç«‹å³è¡Œå‹•**

**å»ºè­°ç«‹å³åŸ·è¡Œ** (åœ¨cmdä¸­):
```cmd
cd G:\WorkFolder\taiwan-stock-system

# 1. ç‚º2330æ”¶é›†ç¾é‡‘æµé‡
python scripts/collect_10_stocks_10years.py --test --batch-size 3

# 2. æª¢æŸ¥çµæœ
python æŸ¥æ‰¾è‚¡ç¥¨è³‡æ–™.py 2330

# 3. é‡æ–°ç”Ÿæˆå ±å‘Š
python generate_stock_report.py 2330
```

**ğŸŠ æ­å–œï¼ç¾é‡‘æµé‡æ”¶é›†åŠŸèƒ½å·²æˆåŠŸä¿®å¾©ï¼Œç¾åœ¨å¯ä»¥æ­£å¸¸è¨ˆç®—ç¾é‡‘æµé‡æ¯”ç‡äº†ï¼**

---

*ä¸‹ä¸€æ­¥ï¼šç‚º2330æ”¶é›†ç¾é‡‘æµé‡è³‡æ–™ï¼Œå®Œæˆå®Œæ•´çš„è²¡å‹™åˆ†æå ±å‘Š*
