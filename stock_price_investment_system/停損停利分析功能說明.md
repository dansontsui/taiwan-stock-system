# 停損停利分析功能說明

## 🎯 功能概述

**全新功能！** 選項5（每月定期定額投資回測）現在會自動分析**最佳停損停利點**，為未來投資提供科學的參考建議！

## 🔍 分析原理

### 基於歷史資料的最佳化
系統會分析每筆交易的：
- **最高報酬點** (`max_return`)：持有期間曾達到的最高報酬率
- **最低報酬點** (`min_return`)：持有期間曾達到的最低報酬率
- **實際報酬** (`actual_return`)：20日到期時的實際報酬率

### 停損停利候選點
- **停損點**：2%, 3%, 5%, 8%, 10%, 15%, 20%
- **停利點**：5%, 8%, 10%, 15%, 20%, 25%, 30%
- **總組合數**：7 × 7 = 49種組合

## 📊 分析流程

### 1. 模擬交易執行
對每筆歷史交易，模擬不同停損停利點的結果：

```python
if max_return >= take_profit:
    # 觸發停利：以停利點出場
    simulated_return = take_profit - transaction_costs
    exit_reason = 'take_profit'
elif min_return <= -stop_loss:
    # 觸發停損：以停損點出場  
    simulated_return = -stop_loss - transaction_costs
    exit_reason = 'stop_loss'
else:
    # 正常到期：以實際報酬出場
    simulated_return = actual_return - transaction_costs
    exit_reason = 'normal'
```

### 2. 績效指標計算
對每種組合計算：
- **平均報酬率**：所有交易的平均報酬
- **勝率**：獲利交易佔總交易的比例
- **最大回撤**：累積報酬的最大跌幅
- **出場原因統計**：停利/停損/正常到期的次數

### 3. 綜合評分
使用加權評分系統：
```python
綜合評分 = 平均報酬(40%) + 勝率(30%) + (100-最大回撤)(30%)
```

## 🏆 分析結果

### 自動輸出檔案
執行選項5後，會在結果目錄生成：

1. **`stop_loss_analysis_TIMESTAMP.json`**
   - 完整的49種組合分析結果
   - 最佳組合詳細資訊
   - 績效改善統計

2. **`optimal_stop_trades_TIMESTAMP.csv`**
   - 使用最佳停損停利點的模擬交易記錄
   - 包含出場原因和模擬報酬

### 即時顯示結果
```
🎯 最佳停損停利分析結果
==================================================
📊 最佳停損停利組合:
   🔻 停損點: 5.0%
   🔺 停利點: 15.0%
   ⭐ 綜合評分: 68.5/100

📈 績效比較:
   項目           原始策略    最佳停損停利    改善幅度
   ─────────────────────────────────────────────
   平均報酬          4.2%         6.1%       +45.2%
   勝率             58.0%        72.0%       +24.1%
   最大回撤         12.5%         8.3%       +33.6%

🚪 出場原因統計:
   🔺 停利出場: 45 筆 (35.2%)
   🔻 停損出場: 28 筆 (21.9%)
   ⏰ 正常到期: 55 筆 (43.0%)
==================================================
```

## 📈 實際應用範例

### 情境分析
假設某筆交易：
- 進場價格：100元
- 期間最高：112元 (+12%)
- 期間最低：95元 (-5%)
- 實際出場：108元 (+8%)

### 不同策略比較
| 停損停利設定 | 出場價格 | 出場原因 | 報酬率 |
|-------------|----------|----------|--------|
| 無設定 | 108元 | 正常到期 | +8.0% |
| 3%停損/10%停利 | 110元 | 觸發停利 | +10.0% |
| 5%停損/15%停利 | 110元 | 觸發停利 | +10.0% |
| 8%停損/20%停利 | 108元 | 正常到期 | +8.0% |

## 💡 投資建議應用

### 1. 風險控制
- **保守型投資者**：選擇較小的停損點（3-5%）
- **積極型投資者**：選擇較大的停損點（8-10%）

### 2. 獲利了結
- **短線操作**：選擇較小的停利點（8-12%）
- **中長線投資**：選擇較大的停利點（15-25%）

### 3. 策略優化
- **高勝率策略**：可設定較寬的停損停利區間
- **高報酬策略**：可設定較緊的停損停利區間

## 🔧 技術特色

### 1. 完整考慮交易成本
- ✅ 每次出場都扣除手續費、證交稅、滑價
- ✅ 真實反映淨報酬
- ✅ 避免過度樂觀的結果

### 2. 多維度評估
- ✅ 不只看報酬率，同時考慮勝率和風險
- ✅ 綜合評分避免單一指標偏差
- ✅ 提供全面的績效比較

### 3. 詳細統計分析
- ✅ 出場原因統計
- ✅ 改善幅度量化
- ✅ 完整的模擬交易記錄

### 4. 自動化分析
- ✅ 無需手動設定，自動測試49種組合
- ✅ 自動找出最佳參數
- ✅ 自動生成分析報告

## 📊 分析結果解讀

### 評分系統
- **80分以上**：優秀，建議採用
- **60-80分**：良好，可考慮採用
- **40-60分**：普通，需謹慎評估
- **40分以下**：不建議，可能不適合

### 改善幅度
- **平均報酬改善 >20%**：顯著改善
- **勝率改善 >15%**：明顯提升
- **最大回撤改善 >25%**：風險大幅降低

### 出場原因分析
- **停利出場比例高**：策略偏向獲利了結
- **停損出場比例高**：策略偏向風險控制
- **正常到期比例高**：停損停利設定較寬鬆

## ✅ 使用建議

### 1. 參考而非絕對
- 停損停利分析提供**參考建議**，不是絕對標準
- 需結合個人風險承受度和投資目標
- 市場環境變化可能影響最佳參數

### 2. 定期重新分析
- 建議每季或每半年重新分析
- 市場特性改變時調整參數
- 結合最新的回測結果

### 3. 靈活應用
- 可針對不同股票設定不同參數
- 可根據市場情況動態調整
- 可結合技術分析進行微調

## 🚀 總結

**停損停利分析功能為量化投資提供了科學的風險管理工具**：

- 🎯 **自動化分析**：49種組合全面測試
- 📊 **科學評分**：多維度綜合評估
- 💰 **真實成本**：完整考慮交易成本
- 📈 **績效改善**：量化分析改善幅度
- 💾 **完整記錄**：詳細的分析結果保存
- 🔍 **未來參考**：為實際投資提供指導

**讓您的投資決策更加科學和理性！** 🎉
