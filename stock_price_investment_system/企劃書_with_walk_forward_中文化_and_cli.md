# 股價預測與投資建議系統（含 Walk-forward 驗證）

> 本文件為「台灣股市營收預測系統」上新增的「股價預測與投資建議系統」之完整企劃書，採用 **Walk-forward（滾動/巢狀驗證）** 流程。所有系統輸出、報表、CLI 顯示與說明文字皆以**中文**為主（編碼輸出為 UTF-8-SIG）。

---

## 目錄

1. 系統概述
2. 資料需求與準備
3. 系統架構
4. Walk-forward 驗證設計（核心）
5. 特徵工程與模型
6. 回測與交易策略
7. 選股（stock-selection）流程
8. CLI 與選單設計（避免記憶參數）
9. 輸出規範（中文化、編碼）
10. 實作里程碑與交付物
11. 風險與注意事項

---

# 1 系統概述

本系統目的為：使用既有之月營收預測結果，結合歷史股價技術特徵，建立「營收→股價→投資建議」完整流程，並以嚴謹的 walk-forward 驗證挑出歷史上模型有效且穩健的個股池，最後在未見樣本中驗證真實績效。

重要設計原則：

- 所有介面與報表**全面中文化**（欄位、圖表標題、說明、commit message 範例），輸出編碼：UTF-8-SIG。
- 嚴格資訊可用性：模擬實際營收公布延遲，避免未來函數。
- Stock-selection 與參數只在訓練期決定，外層測試嚴格隔離。
- 提供直觀 CLI 選單（start.py）以減少操作者需要記憶的 .py 路徑或參數。

# 2 資料需求與準備

**必備資料（最少）**

- 月營收（專案根目錄 data/taiwan_stock.db）: company_id, year, month, revenue, revenue_publish_date（若可用）
- 日級 OHLCV（至少 2015 起）: date, open, high, low, close, volume
- 公司屬性：industry\_code、上市日、退市日、除息日、停牌記錄

**可選（若未取得可暫時省略）**

- 三大法人買賣超、新聞情緒、宏觀因子（利率、匯率）

**資料規則**

- 記錄每筆資料的可用時間（例如：營收在哪一天公布），回測時按照可用時間載入。
- 必須包含退市資料或明確標註排除規則，以避免生存偏差。

# 3 系統架構（目錄化）

```
stock_price_investment_system/
├── start.py                         # 中文互動選單
├── README.md                        # 系統說明
├── data/                            # 本系統資料快取（不放主DB）
├── forecasting/                     # 既有營收預測模組
├── price_models/                    # 營收→股價模型
├── selector/                        # 股票池與選股規則
├── advisor/                         # 投資建議、追蹤與日誌
├── orchestrator/                    # 排程與自動化流程
├── tests/                           # 單元測試
└── reports/                         # 回測報表（HTML、CSV）
```

注意：主 SQLite 資料庫位於專案根目錄的 `../data/taiwan_stock.db`（上層目錄），本系統資料夾內的 `data/` 僅作為快取或輸出用，不存放主DB。

# 4 Walk-forward 驗證設計（核心）

**高階策略**：在 2015–2022（訓練期）執行內層 walk-forward fold（rolling train/test）以：

1. 調參並訓練模型
2. 在每個 fold 的測試期間回測，取得 per-stock 統計
3. 對每檔股票計算跨 fold 的穩健性分數（stock-score）
4. 訓練期結束後依門檻選出「模型友善股票池」
5. 將 freeze 的模型架構、參數與股票池拿到外層 holdout（例如 2023–2024）做最終驗證

**建議預設參數（可調）**：

- 訓練視窗 W\_train = 48 個月
- 測試視窗 W\_test = 12 個月
- 步長 stride = 12 個月（每年移動一次）
- 如需更密集檢驗可改為 stride=1（月移動）

**內層 fold 流程（每一 fold）**：

1. 準備訓練資料（遵守資料發布延遲）
2. 特徵工程與模型訓練（XGBoost/LightGBM）
3. 以月頻信號在 fold 測試期間回測策略（含交易成本、滑價）
4. 記錄每檔股票：勝率、盈虧比、平均持有期、交易次數、最大回撤

**股票池生成（訓練期內）**：

- 對每檔股票的多個 fold 統計做 robust aggregation（median、75% quantile），產生 stock-score
- 入選門檻（範例）：勝率 median ≥ 52%、盈虧比 median ≥ 1.2、至少在 2 個 fold 有交易

# 5 特徵工程與模型

**特徵（在 t 時刻可得）**：

- 營收特徵：當月 YoY、MoM、近 3/6/12 月平均、預測值與預測上下界、預測誤差
- 技術特徵：月 MA(5/20/60)、RSI、MACD、成交量變化、價量齊升指標
- 產業/個股特徵：產業類別 one-hot、上市年限、平均換手率（若可得）

**模型候選**：

- 主力：XGBoost / LightGBM（回歸或分類）
- 基線：Logistic Regression / 均值策略
- 區間/信心：使用 quantile regression 或 ensemble 分散度估計信心

# 6 回測與交易策略

**頻率與執行**：

- 每月生成信號（在可用營收/報表後的第一個可交易日執行）
- 使用日級價格模擬執行（next-open 或當日能成交價）

**選股規則（範例）**：

- 預期中位數報酬 ≥ 5%
- 信心分數 ≥ 60%
- 技術確認：月 MA5 > MA20

**倉位與風控（範例）**：

- 單股權重上限 5%
- 等權或按（信心 × 預期報酬）加權
- 停損 -12%，停利 +20%（參數化，支援 ATR 動態停損）
- 持有期上限 3 個月

**交易成本**：

- 手續費、交易稅、滑價應計入回測（預設手續+稅約 0.4% 但請以實際數值替換）。

# 7 選股（stock-selection）流程（訓練期內）

1. 在每個內層 fold 的回測中對所有股票計算績效統計。
2. 對每檔股票做跨 fold aggregation，產生 stock-score（可自訂加權）。
3. 根據門檻建立候選池（candidate pool）。
4. 在外層 holdout（2023–2024）僅對 candidate pool 做交易。

# 8 CLI 與選單設計（避免操作者需記憶多個 .py 與參數）

**總原則**：

- 提供一個 `start.py` 中文互動選單，所有常用操作可透過選單完成。
- 每個選項提供「預設參數」並支援互動式查詢/修改（以中文顯示）。
- 支援 `--config` 引入 YAML/JSON 配置檔，讓工程師可儲存常用參數組合。

**start.py 選單範例**（中文）

```
歡迎使用 股價預測與投資建議系統
1) 執行月度流程（營收→股價→選股→建議→報告）
2) 只跑 price_models（股價預測）
3) 執行內層 walk-forward（訓練期：2015–2022）並產生 per-stock 統計
4) 生成 candidate pool（由內層結果套門檻）
5) 執行外層回測（2023–2024）
6) 顯示/編輯 config 檔案（中文）
7) 匯出報表（HTML / CSV）
8) 模型管理（列出 / 匯出 / 刪除）
q) 離開
```

**互動式參數輸入範例**：當使用者選擇 `3) 執行內層 walk-forward` 時，系統會顯示：

- 訓練視窗（預設 48 個月） [輸入數字或按 Enter 接受預設]
- 測試視窗（預設 12 個月）
- 步長（預設 12 個月）
- 進階：是否要包含退市股票（Y/N）

使用者確認後系統會執行，不需要記憶任何 .py 路徑或參數變數。

# 9 輸出規範（中文化、檔案編碼與格式）

- 所有 CLI 與報表文字皆**中文**（繁體中文為預設）。
- 所有 CSV、HTML、log 檔案輸出皆使用 `UTF-8-SIG` 編碼以避免 Windows 開啟中文亂碼（避免 cp950 問題）。
- 報表內容至少包含：
  - 每月淨值（NAV）曲線（互動 HTML）
  - 每檔股票績效卡（勝率、盈虧比、平均持有期、最大回撤）
  - 交易紀錄 CSV（含手續、滑價、淨利）
  - stock-score 排名表

# 10 實作里程碑與交付物

**里程碑建議**：

1. 資料整備與格式化（1 週）
2. 實作內層 walk-forward pipeline（2 週）
3. stock-selection 規則化（1 週）
4. 外層 holdout 回測（1 週）
5. CLI 與報表輸出（1 週）

**交付物**：

- Markdown 企劃書（本文件）
- 內層 fold 報表（CSV/HTML）
- candidate pool 清單（CSV）
- 外層回測報告（interactive HTML + CSV）
- Model artifacts（best\_model.pkl、best\_params.json）

# 11 風險與注意事項

- **未來函數風險**：選股與參數僅可用訓練期資料決定，外層絕不可洩漏訓練期以後的資訊。
- **存活偏差**：回測應包含退市資料或明確記錄排除條件。
- **市場結構改變**：若外層測試失敗，可能為市場結構變動或策略過擬合；需重新檢視特徵或納入額外因子。
- **分散化降低**：篩選後股票池縮小，需額外調整單股權重或引入多策略搭配。

---

## 附錄：start.py 範例互動邏輯（簡述）

- 程式入口：`python start.py [--config=config.yaml]`
- 若無 `--config`，進入互動式中文選單。
- 選單每項會顯示預設參數，使用者可按 Enter 接受或輸入新值。
- 所有操作均記錄到 `logs/`，並自動在 `reports/` 生成報表檔案與 `Project_status.md`。

---

如需我將此 Markdown 存為 repo 裡的 `systems/stock_price_investment_system/企劃書_with_walkforward.md`，或把 `start.py` 的互動範本與 `config.yaml` 範例產出為程式檔，我可以進一步幫你產出。

您的系統中的 Fold 參數
🔧 預設設定
Fold = 一個完整的「訓練-測試」循環

在Walk-Forward驗證中，每個fold包含：

訓練期間：用來訓練模型的歷史資料
測試期間：用來驗證模型效果的未來資料
🎯 Fold 的運作方式
時間軸: 2015 -------- 2020 -------- 2025
        |              |              |
        訓練期          測試期         下一個訓練期

Fold 1: [2015-2018] → 預測 [2019]
Fold 2: [2016-2019] → 預測 [2020]  
Fold 3: [2017-2020] → 預測 [2021]
Fold 4: [2018-2021] → 預測 [2022]
...
