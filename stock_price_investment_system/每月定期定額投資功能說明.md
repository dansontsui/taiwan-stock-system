# 每月定期定額投資回測功能說明

## 🎯 功能概述

新增的**選項5a - 每月定期定額投資回測**功能，實現了更貼近實際投資情況的回測方式：

- 💰 **每月固定投資金額**：預設每月投入100萬元（可自訂）
- 📊 **平均分配資金**：將每月資金平均分配到入選股票
- 💸 **完整交易成本**：計入手續費、證交稅、滑價等所有成本
- 📈 **真實投資模擬**：模擬實際定期定額投資行為

## 🔧 交易成本設計

### 成本項目
根據 `settings.py` 中的配置：

```python
'transaction_costs': {
    'commission_rate': 0.001425,   # 手續費0.1425%
    'tax_rate': 0.003,             # 證交稅0.3%
    'slippage_bps': 5,             # 滑價5個基點(0.05%)
}
```

### 滑價 (slippage_bps) 設計用意

**滑價**代表實際成交價與預期價格的差異，設定為5個基點(0.05%)的原因：

1. **市場衝擊**：大額交易可能推動價格變動
2. **買賣價差**：Bid-Ask Spread的影響
3. **流動性成本**：特別是中小型股票
4. **執行延遲**：信號產生到實際下單的時間差
5. **保守估計**：確保回測結果不過度樂觀

### 成本計算範例

以股價100元、1000股為例：

```
買進成本：
- 手續費：100,000 × 0.1425% = 142.50元
- 滑價：100,000 × 0.05% = 50.00元

賣出成本（假設110元賣出）：
- 手續費：110,000 × 0.1425% = 156.75元
- 證交稅：110,000 × 0.3% = 330.00元
- 滑價：110,000 × 0.05% = 55.00元

總交易成本：734.25元
成本率：0.73%

毛報酬：10.00%
淨報酬：9.27%
成本影響：0.73%
```

## 💰 每月定期定額投資邏輯

### 投資流程

1. **每月月底**：執行股票篩選和預測
2. **資金分配**：將固定金額平均分配到入選股票
3. **股數計算**：扣除交易成本後計算可購買股數
4. **持有期間**：持有20個交易日後賣出
5. **績效計算**：計算當月報酬率和累積績效

### 股數計算邏輯

```python
# 扣除買進成本後的可用金額
buy_cost_rate = 手續費率 + 滑價率
available_amount = 投資金額 / (1 + buy_cost_rate)

# 計算股數（以1000股為單位）
shares = int(available_amount / 股價 / 1000) * 1000
shares = max(shares, 1000)  # 最少買1000股
```

### 投資範例

假設每月投資100萬，選中3檔股票：

```
每月投資總額：1,000,000元
每檔股票分配：333,333元

股票A (500元)：333,333元 ÷ 500元 = 666股 → 買1,000股 = 500,000元
股票B (100元)：333,333元 ÷ 100元 = 3,333股 → 買3,000股 = 300,000元  
股票C (200元)：333,333元 ÷ 200元 = 1,666股 → 買1,000股 = 200,000元

實際投資：1,000,000元
剩餘資金：0元
```

## 📊 績效指標

### 基本指標
- **總投入金額**：累積投資總額
- **總資產價值**：當前持股總價值
- **總報酬率**：(總價值 - 總投入) / 總投入
- **總損益**：絕對損益金額

### 風險指標
- **年化報酬率**：月報酬年化後的數值
- **年化波動率**：月報酬波動的年化數值
- **夏普比率**：風險調整後報酬
- **最大回撤**：累積淨值的最大跌幅

### 勝率統計
- **月度勝率**：獲利月份佔總投資月份比例
- **平均月報酬**：每月報酬率的平均值
- **月報酬波動**：月報酬率的標準差

## 🚀 使用方式

### 1. 啟動系統
```bash
python stock_price_investment_system/start.py
```

### 2. 選擇功能
選擇 **5a) 執行每月定期定額投資回測（含交易成本）**

### 3. 設定參數
- **投資期間**：例如 2023-01 ~ 2025-07
- **每月投資金額**：預設1,000,000元
- **最小預測報酬門檻**：例如2%
- **每月最多持股數**：例如10檔
- **市場濾網**：是否啟用技術面過濾

### 4. 查看結果
系統會顯示：
- 每月投資詳情
- 累積績效指標
- 風險分析報告
- 交易成本影響

## 🔍 與原版回測的差異

| 項目 | 原版回測(選項5) | 每月定期定額(選項5a) |
|------|----------------|---------------------|
| 投資方式 | 等權重配置 | 每月固定金額平均分配 |
| 交易成本 | 未計入 | 完整計入所有成本 |
| 資金管理 | 一次性投入 | 每月定期投入 |
| 股數計算 | 理論計算 | 實際可購買股數 |
| 報酬計算 | 毛報酬 | 淨報酬（扣除成本） |
| 適用場景 | 理論回測 | 實際投資模擬 |

## 💡 使用建議

1. **建議執行順序**：9→3→4→5a
2. **參數設定**：保守設定預測門檻，避免過度交易
3. **成本敏感性**：觀察交易成本對績效的影響
4. **定期檢視**：每月檢視投資組合表現
5. **風險控制**：注意最大回撤和波動率指標

這個功能讓回測結果更貼近實際投資情況，幫助您做出更明智的投資決策！
