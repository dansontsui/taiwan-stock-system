# 股價預測與投資建議系統 企劃書（基於台灣股市營收預測系統）

本企劃書規劃在既有「台灣股市營收預測系統」之上，新增「股價預測與投資建議系統」。沿用現有的營收預測回測框架與參數優化能力，建立由營收→股價→投資建議的完整流程。

---

## 1. 系統架構設計

### 1.1 資料流程
1) 資料層：
- 既有資料庫：月營收（data/taiwan_stock.db）
- 新增資料：歷史股價（日/週/月K）、市場因子（加權指數、產業指數、利率/匯率等）

2) 預測層：
- 營收預測（沿用 forecasting/ 現有系統）
- 營收→股價轉換模型（新增 price_models/）
- 股價預測（短/中期，輸出區間與方向）

3) 決策層：
- 每月自動篩選（新月營收入庫觸發）
- 投資建議引擎（買賣點、停損停利、追蹤清單）
- 報告與視覺化（互動HTML/CSV/圖表）

4) 編排層：
- 排程（每日檢查/每月觸發）
- 參數優化與回測
- 模型/參數管理（best_params.json + best_model）

### 1.2 模組互動
- forecasting（既有） → 產出每檔股票未來 1 期營收預測與回測表現
- price_models（新） → 以營收預測與市場特徵，產出股價預測
- selector（新） → 依股價預測分數與風險控管產生月度推薦名單
- advisor（新） → 生成買賣點與停損停利建議、維護追蹤清單
- orchestrator（新） → 自動化流程：新資料→調校→回測→股價預測→名單→報告

### 1.3 技術選型
- Python（pandas、numpy、xgboost、prophet 可選）、SQLite
- 視覺化：Plotly（互動HTML）、matplotlib（備援）
- CLI 與選單：start.py（中文輸出，UTF-8-SIG 避免 cp950）
- 全面中文化原則：所有 CLI 輸出與報表欄位、圖表標題、說明文字一律使用中文，避免英文訊息
- 編碼規範：所有文字輸出、CSV、HTML 檔案以 UTF-8-SIG 編碼輸出，避免 Windows cp950 錯誤

---

## 2. 預測方法論

### 2.1 營收→股價轉換
- 假設：營收成長（MoM/YoY）與股價報酬有領先/同步關聯
- 策略：
  1) 先預測下一期營收（既有）
  2) 建立「營收特徵 → 未來股價報酬」模型（如未來1/3個月）
  3) 模型輸出為「方向 + 區間報酬」與信心分數
- 注意：以現行成效估算（2385 MAPE 10.14%、2330 MAPE 12.09%），股價預測需提供區間/機率結果，不以單點斷言。

### 2.2 模型與 Prompt
- ML：XGBoost/LightGBM（橫截面特徵→報酬/方向）、Prophet/ARIMA（股價基線）
- LLM 輔助（選配）：
  - 功能：解釋輸出、產業摘要、風險事件彙整
  - Prompt 範例：
    - 「給定某檔股票的營收成長特徵（近12月YoY、MoM循環）、市場因子（加權指數、利率）、技術指標（MA、RSI），請以保守語氣輸出下月區間報酬估計、中位數預期報酬、主要風險與反駁點。」

### 2.3 特徵工程
- 營收：YoY/MoM、季節性、滯後、移動平均、預測上下界
- 市場：加權指數報酬、利率、匯率、產業指數
- 技術：MA(5/20/60)、RSI、MACD、布林、量變化
- 目標：未來1/3月報酬或方向；以月頻對齊，使用當期可得資訊

---

## 3. 驗證與回測框架

### 3.1 方法
- 時間滾動視窗：固定視窗訓練、預測下一期報酬
- 避免未來函數：僅用當期已知資訊
- 多標的回測：每月全市場掃描，計算組合績效

### 3.2 指標
- 個股：方向準確率、MAE/MSE、MAPE（若用幅度）
- 組合：年化報酬、波動度、夏普、最大回撤、命中率、勝率、Turnover

### 3.3 風控
- 單股：停損（-10%~-15%）、停利（+15%~+25%）可參數化
- 組合：單股權重上限、產業曝險限制、持股數量上限
- 事件：財報/除息前後觀察期不調整或降權


### 3.4 Walk-forward 驗證設計（核心）
- 設定（可調）：
  - 訓練視窗 W_train = 48 個月
  - 測試視窗 W_test = 12 個月
  - 步長 stride = 12 個月（可改為 1 代表逐月）
- 內層流程（每個 fold）：
  1) 準備訓練資料（遵守資料發布延遲，避免未來函數）
  2) 特徵工程與模型訓練（XGBoost/LightGBM 等）
  3) 在 fold 測試期間以月頻生成信號、用日級價格模擬執行（next-open 或可成交價），納入手續費、交易稅、滑價
  4) 對每檔股票記錄：勝率、盈虧比、平均持有期、交易次數、最大回撤等統計
- 股票池生成（訓練期內）：
  - 對每檔股票跨 fold 做穩健聚合（median、75% 分位數），產生 stock-score
  - 入選門檻（範例）：勝率 median ≥ 52%、盈虧比 median ≥ 1.2、至少 2 個 fold 有交易
- 外層 holdout：
  - 將內層凍結之模型架構/參數與 candidate pool（入池股票）帶到 2023–2024 等未見樣本做最終驗證
  - 僅對 candidate pool 做交易，檢驗真實可行性

### 3.5 交易執行與成本（統一規範）
- 頻率：每月生成信號，於可用營收/報表後的第一個可交易日執行
- 成本：手續費、交易稅、滑價皆計入（以專案環境實際數值設定，預設合計約 0.2%~0.4%）
- 風控與倉位：
  - 單股權重上限（如 5%~10%）；等權或按（信心 × 預期報酬）加權
  - 停損（-10%~-15%）、停利（+15%~+25%）、持有期上限（如 3 個月）

---

## 4. 實作細節

### 4.1 自動化觸發
- 由 forecasting/cli.py 的每日檢查擴充：偵測新月份資料→依序觸發：
  1) 參數調校（選單6）
  2) 回測（選單5）
  3) 單次預測（選單1，取得三情境）
  4) 股價預測（price_models/）

---

## 6. 目錄與模組（合併版）

```
stock_price_investment_system/
├── start.py                         # 中文互動選單（支援 --config）
├── 系統企劃書.md                      # 本文件（合併版）
├── forecasting/                     # 既有營收預測模組（引用或子模組）
├── price_models/                    # 營收→股價模型
├── selector/                        # 股票池與選股規則（stock-score 門檻、排名）
├── advisor/                         # 投資建議、追蹤與日誌
├── orchestrator/                    # 排程與自動化流程（含 Project_status 自動寫入與 git push）
├── reports/                         # 回測與交易報表（HTML、CSV，中文化）
└── tests/                           # 單元與端到端測試
```

### 6.1 start.py 功能選單（擴充版）
- 1) 執行月度流程（營收→股價→選股→建議→報告）
- 2) 只跑股價預測
- 3) 只產生投資建議
- 4) 查看追蹤清單
- 5) AI 模型訓練（股價模型）
- 6) 參數調校與優化（股價模型）
- 7) 回測與模型評估（股價模型）
- 8) 模型與參數管理（列出/匯出/刪除）
- 9) 報表輸出（HTML/CSV，中文）
- 10) 生成 candidate pool（內層統計套門檻）
- 11) 執行外層 holdout 回測
- q) 離開系統

---

## 7. 輸出規範與中文化（統一）
- CLI 與報表文字皆為繁體中文；欄位、圖表標題、提示說明，不輸出英文錯誤訊息
- 檔案編碼：CSV/HTML/log 一律 UTF-8-SIG（避免 cp950）
- 報表內容至少包含：
  - 每月淨值（NAV）曲線（互動 HTML）
  - 每檔股票績效卡（勝率、盈虧比、平均持有期、最大回撤）
  - 交易紀錄 CSV（含手續、滑價、淨利）
  - stock-score 排名表

---

## 8. 整體測試計畫（合併）

### 8.1 測試目標
- 跨平台可執行（Mac/Windows），避免 cp950 編碼問題
- 核心功能可啟動、選單可顯示中文、互動可結束
- Walk-forward 切分與 candidate pool 聚合正確

### 8.2 測試類型
- 單元測試：
  - start.py 選單顯示與中文輸出；輸入 q 正常結束
  - 功能 5/6/7/8/9/10/11：選擇後輸出中文占位訊息（不出現英文錯誤）
  - Walk-forward 切分（W_train/W_test/stride）正確性
  - candidate pool 聚合與門檻（median/分位數）
  - 資料可用性檢查（營收公布延遲、退市處理）
- 端到端（MVP）：
  - 以 10 檔示範標的完整跑：內層 fold → candidate pool → 外層 holdout → 報表 → 自動更新 Project_status.md → commit/push（dry-run）

### 8.3 測試執行
- 指令：
```
pytest -q
```
- 驗收標準：
  - 測試全數通過；無 UnicodeEncodeError；選單與報表輸出為中文
  - 自動化腳本可成功更新 Project_status.md 並完成 git commit / push（以 dry-run 模式測試）

---

## 9. 可行性結論與建議
- 以現有營收預測效能（MAPE 10~12%）作為輸入，能構建營收→股價的預測鏈；但需以區間與風險控管呈現建議，並透過 walk-forward + 外層 holdout 驗證穩健性
- 建議先以 10 檔示範標的建立 MVP，完成端到端與組合績效驗證，再擴大覆蓋

  5) 推薦名單（selector/）
  6) 投資建議（advisor/）
  7) 互動 HTML 報告（中文化圖表與說明）
  8) 自動撰寫 Project_status.md（最新狀態、指標、路徑、時間戳）
  9) 自動 git commit 與 push（commit message 使用中文摘要）

### 4.2 篩選演算法（selector）
- 輸入：預期報酬中位數、置信區間、回測映射分數（mape↓、趨勢↑）、波動/回撤
- 輸出：月度 Top N 名單，每檔評分卡（預期報酬、置信、風險、建議）

### 4.3 追蹤清單（advisor）
- watchlist.csv：代碼、建議價格、停損、停利、狀態
- 每日更新：觸發信號（停損/停利、達到買/賣點）
- 紀錄：logs/watchlist.log（進出場）

### 4.4 買賣信號
- 入場：預期報酬>門檻且信心>門檻，並有技術確認（MA上穿、量價配合）
- 出場：固定或波動式停損/停利（ATR）
- 權重：誤差擴大→降權；穩健→維持或小幅加碼

---

## 5. 風險評估與限制
- 營收預測 MAPE 約 10~12%，股價不確定性放大 → 採用區間/機率結果
- 系統性風險（升息、地緣、流動性）可能主導股價 → 降低單一模型依賴
- 報告需揭露不確定性與假設

---

## 6. 新增資料夾結構與功能選單

```
stock_price_investment_system/
├── start.py                         # 功能選單（中文輸出）
├── 系統企劃書.md                      # 本文件
├── price_models/                    # 營收→股價模型（未來擴充）
├── advisor/                         # 建議與追蹤（未來擴充）
├── orchestrator/                    # 排程與流程（未來擴充）
└── tests/                           # 單元測試（未來擴充）
```

### 6.1 start.py 功能選單（擴充版）
- 1) 執行月度流程（營收→股價→選股→建議→報告）
- 2) 只跑股價預測
- 3) 只產生投資建議
- 4) 查看追蹤清單
- 5) AI 模型訓練（股價模型）
- 6) 參數調校與優化（股價模型）
- 7) 回測與模型評估（股價模型）
- 8) 模型與參數管理（列出/匯出/刪除）
- q) 離開系統

---

## 7. 整體測試計畫

### 7.1 測試目標
- 跨平台可執行（Mac/Windows），避免 cp950 編碼問題
- 核心功能可啟動、選單可顯示中文、互動可結束

### 7.2 測試類型
- 單元測試：
  - start.py 顯示選單（包含中文標題與選項）
  - 輸入 q 可正常結束
  - 功能 5/6/7/8：選擇後會輸出中文占位訊息（不出現英文錯誤）
- 端到端（未來）：
  - 自動觸發月度流程（模擬新月份資料）
  - 產生股價預測與名單 → 報告輸出
  - 模型訓練→調校→回測→預測→建議 全流程乾跑（mock 資料）

### 7.3 測試執行
- 指令：
```
pytest -q tests/test_stock_price_system_cli.py
```
- 驗收標準：
  - 測試全數通過；無 UnicodeEncodeError；選單輸出為中文
  - 自動化腳本可成功更新 Project_status.md 並完成 git commit / push（以 dry-run 模式測試）

---

## 8. 可行性結論與建議
- 以現有營收預測效能（MAPE 10~12%）作為輸入，能構建營收→股價的預測鏈，但需以區間與風險控管呈現建議。
- 建議以 10 檔示範標的建立 MVP，完成端到端與組合績效驗證，再逐步擴大覆蓋。

