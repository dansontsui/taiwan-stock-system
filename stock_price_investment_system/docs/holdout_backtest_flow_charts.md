# 外層回測流程圖表

本文件包含選單5外層回測的詳細流程圖表，用於說明交易時機和AI模型訓練機制。

## 1. 外層回測交易時機流程圖

```mermaid
graph TD
    A[開始外層回測<br/>2023-01 到 2024-12] --> B[生成月底日期序列<br/>freq='M']
    B --> C[2023-01-31<br/>第一個月底]
    C --> D[訓練AI模型<br/>使用2015-01到2023-01-31的資料]
    D --> E[對4檔候選股票進行預測]
    E --> F[篩選預測報酬>-5%的股票]
    F --> G[在月底買入符合條件的股票]
    G --> H[持有20天後賣出]
    H --> I[下個月底<br/>2023-02-28]
    I --> J[重新訓練模型<br/>使用2015-01到2023-02-28的資料]
    J --> K[重複預測→買入→持有→賣出]
    K --> L[...持續到2024-12-31]
    
    style C fill:#e1f5fe
    style I fill:#e1f5fe
    style G fill:#c8e6c9
    style H fill:#ffcdd2
```

## 2. 交易執行細節流程圖

```mermaid
graph LR
    A[月底日期<br/>如2023-01-31] --> B[獲取當日收盤價<br/>作為買入價]
    B --> C[計算賣出日期<br/>買入日+20天]
    C --> D[獲取賣出日實際收盤價]
    D --> E[計算實際報酬率<br/>exit_price - entry_price / entry_price]
    
    F[買入條件] --> G[預測報酬 > -5%]
    G --> H[按預測報酬排序<br/>高者優先]
    H --> I[等權重買入所有符合條件股票]
    
    style A fill:#e3f2fd
    style E fill:#c8e6c9
    style G fill:#fff3e0
```

## 3. 滾動式AI模型訓練時間軸

```mermaid
timeline
    title 外層回測滾動式AI訓練時間軸
    
    section 2023年1月
        2023-01-31 : 訓練資料期間
                   : 2015-01-01 到 2023-01-31
                   : 重新訓練4檔股票的AI模型
                   : 進行預測並交易
    
    section 2023年2月  
        2023-02-28 : 訓練資料期間
                   : 2015-01-01 到 2023-02-28
                   : 重新訓練4檔股票的AI模型
                   : 進行預測並交易
    
    section 2023年3月
        2023-03-31 : 訓練資料期間
                   : 2015-01-01 到 2023-03-31
                   : 重新訓練4檔股票的AI模型
                   : 進行預測並交易
                   
    section ...持續到
        2024-12-31 : 訓練資料期間
                   : 2015-01-01 到 2024-12-31
                   : 重新訓練4檔股票的AI模型
                   : 進行預測並交易
```

## 關鍵說明

### 交易頻率與時機
- **交易頻率**：每月一次（月底）
- **買入時機**：每個月最後一個交易日
- **持有期間**：固定20天
- **不是每日交易**：系統不會每天檢查股價來決定買賣

### AI模型重訓練機制
- **頻率**：每個月重新訓練一次
- **訓練資料**：從2015-01-01到當前月底的所有資料
- **模型更新**：每次都是完全重新訓練，不是增量學習
- **個股專屬**：每檔股票都有自己的最佳參數模型

### 完整流程
1. **月底觸發**：每個月最後一天
2. **重新訓練**：用最新資料重訓4檔股票的AI模型
3. **預測報酬**：對每檔股票預測未來20天報酬
4. **篩選股票**：選擇預測報酬>-5%的股票
5. **等權買入**：在月底收盤價買入
6. **持有20天**：固定持有期間
7. **自動賣出**：20天後以收盤價賣出
8. **下月重複**：進入下個月循環

### 實際結果
- **測試期間**：2023-01 到 2024-12（24個月）
- **總交易數**：57筆
- **總報酬率**：73.45%
- **勝率**：66.7%
- **候選股票**：1314, 1309, 1319, 1215（4檔）
