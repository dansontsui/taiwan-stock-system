## 系統架構與方法論說明

### 1. 個股模型架構（Per-Stock Models）
- 當前系統的 AI/ML 模型（Prophet、LSTM、XGBoost）皆以「單一股票」為單位進行訓練與預測。
- 實作重點：
  - `choose_best_model(df, stock_id)` 會將 `stock_id` 傳遞至各模型訓練（Prophet/LSTM/XGBoost），以便載入/應用該股票的最佳超參數。
  - 若啟用參數優化，最佳參數將以 `{stock_id, model}` 為鍵儲存並載入，避免使用通用模型，能捕捉個股趨勢與季節性差異。

### 2. AI/ML 與傳統財務方法的佔比
- 本系統目前「主要依賴 AI/ML」進行預測：Prophet（趨勢/季節）、XGBoost（多變量回歸）、LSTM（深度時序）。
- 傳統財務公式僅作為資料清理與異常檢查的輔助，非核心預測。約略佔比：
  - AI/ML 模型：≈ 85%（主要貢獻來源）
  - 財務邏輯與規則：≈ 15%（落地合理性與邊界約束）

### 3. 特徵工程中納入的財務比率/公式
- 目前已納入：
  - 滯後（lag1/3/6/12）與移動平均（ma3/6/12）
  - 月份 one-hot（month_1~month_12）
- 可選擇性納入（multivariate.py）：
  - 財務報表（綜合損益表、資產負債表、現金流量表）
  - 財務比率（如毛利率、淨利率、費用率、週轉率等）
- 現階段以「原始欄位（raw values）」為主；比率計算可再擴充（例如：毛利率 = 毛利/營收）

### 4. 異常檢測規則結合 AI 與財務邏輯
- 規則 1：預測值 > 1.5 × 歷史最大 → 標記異常並上限調整
- 規則 2：近12月均值作「穩定代理」，若 > 1.3×均值 → 異常並平滑
- 規則 3：季節性偏差 > 3×同月歷史標準差 → 回調至 3σ 邊界
- 結合方式：
  - 先以 AI/ML 產出預測點與區間
  - 再由上述財務規則進行「合規調整」與標記（anomaly_flag）
  - 不直接覆蓋樂觀/保守情境，僅對基準情境（baseline）做合理化（系統輸出保留三情境）

### 5. 多變量特徵（multivariate）的使用方式
- 目前多變量特徵整合偏向「原始值」（raw values）的直接合併（不同表格以日期為鍵左連接），並對數值欄進行前向填補+0處理。
- 若需改用比率，可在 multivariate.py 中擴充：
  - 例如：應收帳款週轉率、庫存週轉天數、毛利率/營業利益率/淨利率等
  - 並加入到 XGBoost 的數值特徵集中

### 6. 回測與參數調校
- 回測：時間滾動視窗（rolling window），計算 MAPE/RMSE 與趨勢方向準確率
- 詳細歷史紀錄：每期的「回測年月/預測/實際/誤差」已輸出為 CSV 並可視覺化
- 參數調校：針對啟用的模型執行多組參數測試，最佳參數以 `{stock_id, model}` 儲存，並自動套用於主預測

### 7. 輸出與相容性
- 所有 CSV/JSON 以 UTF-8-SIG 編碼，避免 Windows cp950 問題
- 產圖優先使用 Matplotlib，缺失時以 SVG 佔位圖回退
- 所有功能在 Mac/Windows 上均可執行

