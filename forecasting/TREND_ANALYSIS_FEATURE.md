# 趨勢分析與回測準確率功能說明

## 🎯 功能概述

已成功實現單次預測中的趨勢分析功能，現在會顯示：
1. **各模型的趨勢預測方向**（上漲/下跌）及變化幅度
2. **回測趨勢準確率**：顯示各模型在歷史回測中的趨勢預測準確度
3. **智能趨勢判斷**：基於最新營收與預測值的比較

## ✨ 新功能特色

### 1. 趨勢方向分析
- **自動計算趨勢方向**：比較預測值與最新營收，判斷上漲📈或下跌📉
- **變化幅度顯示**：精確計算變化百分比，如 `-4.8%` 或 `+2.3%`
- **雙模型比較**：同時顯示 XGBoost 和 Prophet 的趨勢預測

### 2. 回測趨勢準確率
- **歷史驗證**：基於回測結果計算趨勢預測的準確率
- **智能評級**：
  - ✅ **≥80%**：優秀準確率
  - ⚠️ **60-79%**：中等準確率  
  - ❌ **<60%**：需要改進
- **模型比較**：清楚標示哪個模型的趨勢預測更可靠

### 3. 趨勢準確率計算邏輯
```python
# 趨勢準確率計算方式
實際趨勢 = 1 if 實際值 > 前期值 else 0  # 1=上升, 0=下降
預測趨勢 = 1 if 預測值 > 前期值 else 0  # 1=上升, 0=下降
趨勢準確率 = 正確預測次數 / 總預測次數
```

## 📊 實際輸出範例

```
============================================================
📈 趨勢分析與回測表現
============================================================
📅 最新營收月份: 2025-06
💰 最新營收金額: 8,346,496,000
📊 預測月份: 2025-07

🔍 各模型趨勢預測:
   📉 XGBoost: 下跌 (-0.0%)
   📉 Prophet 🏆: 下跌 (-4.8%)

📊 回測趨勢準確率:
   ⚠️ Prophet 🏆: 63.8%
   ❌ XGBoost: 56.4%
```

## 🔧 技術實現

### 新增函數
1. **`analyze_prediction_trends(stock_id, baseline_values)`**
   - 分析各模型的趨勢方向
   - 計算變化幅度和百分比
   - 返回完整的趨勢分析結果

2. **`get_backtest_trend_accuracy(stock_id)`**
   - 從 `best_params.json` 讀取回測結果
   - 提取各模型的趨勢準確率
   - 支援多模型準確率比較

### 回測結果保存增強
- 修改 `run_backtest_analysis()` 函數
- 自動保存趨勢準確率到 `best_params.json`
- 格式：`{stock_id}_{model_name}_backtest_result`

### 資料結構
```json
{
  "2385": {
    "Prophet_backtest_result": {
      "mape": 0.1092,
      "rmse": 1234567890,
      "trend_accuracy": 0.638,
      "n_predictions": 163
    },
    "XGBoost_backtest_result": {
      "mape": 0.1782,
      "rmse": 2345678901,
      "trend_accuracy": 0.564,
      "n_predictions": 163
    }
  }
}
```

## 📈 實際測試結果

以 **2385 群創光電** 為例：

### 趨勢預測分析
- **最新營收**：8,346,496,000 元（2025-06）
- **XGBoost 預測**：8,343,054,336 元 → 📉 下跌 (-0.0%)
- **Prophet 預測**：7,949,761,896 元 → 📉 下跌 (-4.8%)

### 回測趨勢準確率
- **Prophet**：63.8% ⚠️（中等準確率）
- **XGBoost**：56.4% ❌（需要改進）

### 投資決策參考
1. **兩個模型都預測下跌趨勢**，建議謹慎
2. **Prophet 的趨勢準確率較高**（63.8% vs 56.4%）
3. **Prophet 預測跌幅較大**（-4.8%），需要關注

## 🚀 使用方式

1. **執行回測**（建議先做）：
   ```bash
   python forecasting/menu.py
   選擇：5) 回測與模型評估
   ```

2. **單次預測**（查看趨勢分析）：
   ```bash
   python forecasting/menu.py
   選擇：1) 單次預測
   ```

## ✅ 測試驗證

- ✅ 趨勢方向判斷正確性
- ✅ 變化幅度計算準確性
- ✅ 回測準確率讀取功能
- ✅ 資料格式驗證
- ✅ 異常處理機制
- ✅ 中文顯示無編碼問題

## 🎯 功能價值

### 1. 投資決策支援
- **趨勢一致性**：兩個模型都預測同方向時，可信度較高
- **準確率參考**：優先參考趨勢準確率較高的模型
- **風險評估**：預測分歧時需要更謹慎

### 2. 模型評估
- **歷史表現**：趨勢準確率反映模型的實際預測能力
- **模型選擇**：幫助選擇趨勢預測更可靠的模型
- **改進方向**：識別需要優化的模型

### 3. 系統完整性
- **端到端分析**：從預測到趨勢判斷的完整流程
- **歷史驗證**：基於實際回測結果的可信度評估
- **用戶友善**：直觀的圖示和中文說明

## 🔮 後續改進建議

1. **趨勢強度分析**：加入趨勢強度指標（微跌、大跌、微漲、大漲）
2. **季節性趨勢**：考慮季節性因素對趨勢判斷的影響
3. **多期趨勢**：預測未來3個月的趨勢方向
4. **趨勢信心度**：基於模型不確定性計算趨勢預測信心度

---

**更新日期**: 2025-08-14  
**功能狀態**: ✅ 已完成並測試通過  
**測試覆蓋**: 趨勢分析、準確率獲取、方向判斷、格式驗證
