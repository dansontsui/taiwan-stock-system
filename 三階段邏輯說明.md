# 🎯 選股系統三階段邏輯說明

## 📋 **正確的執行順序**

### **階段1：Walk-forward驗證（選單3）**
- **目的**：生成歷史統計資料
- **使用參數**：`walkforward_params`（寬鬆條件）
- **輸出**：`walk_forward_results.json`
- **條件設定**：
  ```
  最小預期報酬: 3%（寬鬆，生成更多交易記錄）
  最小信心分數: 50%（寬鬆，生成更多交易記錄）
  技術面確認: 關閉（寬鬆，生成更多交易記錄）
  最大相關性: 80%（寬鬆）
  ```

### **階段2：候選池生成（選單4）**
- **目的**：從歷史統計中篩選優質股票
- **使用參數**：`candidate_pool_thresholds`（中等條件）
- **輸入**：階段1的統計結果
- **輸出**：`candidate_pool.json`
- **條件設定**：
  ```
  最小勝率: 50%（與實際選股一致）
  最小盈虧比: 1.3（與實際選股一致）
  最小交易數: 5（確保統計意義）
  最少fold數: 0（修正bug）
  最大回撤: 40%（與實際選股一致）
  ```

### **階段3：實際選股（外層回測）**
- **目的**：最終交易決策
- **使用參數**：`selection_rules`（嚴格條件）
- **輸入**：階段2的候選池
- **輸出**：實際交易記錄
- **條件設定**：
  ```
  最小預期報酬: 5%（嚴格，最終交易門檻）
  最小信心分數: 60%（嚴格，最終交易門檻）
  技術面確認: 開啟（嚴格，最終交易門檻）
  最大相關性: 70%（嚴格，最終交易門檻）
  ```

## 🔄 **條件同步邏輯**

### **為什麼需要三階段？**

1. **階段1寬鬆**：
   - 目的是生成足夠的歷史交易記錄
   - 如果條件太嚴格，會導致交易記錄太少，統計不準確
   - 寬鬆條件確保每檔股票都有足夠的歷史表現資料

2. **階段2中等**：
   - 基於階段1的統計結果進行篩選
   - 排除明顯表現不佳的股票
   - 為階段3提供高品質的候選池

3. **階段3嚴格**：
   - 最終的交易決策門檻
   - 確保只有最優質的股票才會被實際交易
   - 控制風險和提高勝率

### **條件遞進關係**

```
階段1（3%） → 階段2（50%勝率） → 階段3（5%）
   ↓              ↓                ↓
生成交易記錄    篩選優質股票      最終交易決策
```

## 🎯 **實際使用流程**

### **步驟1：執行選單3**
```
python stock_price_investment_system/start.py
選擇：3 (Walk-forward驗證)
```
- 使用寬鬆的 `walkforward_params`
- 生成歷史統計資料
- 輸出：`walk_forward_results_YYYYMMDD_HHMMSS.json`

### **步驟2：執行選單4**
```
python stock_price_investment_system/start.py
選擇：4 (候選池生成)
```
- 使用中等的 `candidate_pool_thresholds`
- 從步驟1的結果中篩選優質股票
- 輸出：`candidate_pool_YYYYMMDD_HHMMSS.json`

### **步驟3：執行外層回測**
```
python stock_price_investment_system/start.py
選擇：1 (外層回測)
```
- 使用嚴格的 `selection_rules`
- 從步驟2的候選池中進行最終選股
- 輸出：實際交易記錄和績效報告

## ✅ **修正前後對比**

### **修正前的問題**：
- 選單3和選單4使用不同的條件系統
- 選單3能找到股票，選單4找不到股票
- 條件不一致導致結果矛盾

### **修正後的改進**：
- 三階段條件有邏輯遞進關係
- 每個階段都有明確的目的和適當的門檻
- 選單3和選單4的結果現在一致了

## 🔧 **配置檔案位置**

所有條件設定都在：
```
stock_price_investment_system/config/settings.py
```

在 `SELECTION_CONFIG` 區塊中：
- `walkforward_params`：階段1參數
- `candidate_pool_thresholds`：階段2參數  
- `selection_rules`：階段3參數

## 💡 **調整建議**

如果發現：
- **階段1交易記錄太少**：放寬 `walkforward_params`
- **階段2候選池為空**：放寬 `candidate_pool_thresholds`
- **階段3沒有交易**：放寬 `selection_rules`

記住：**階段1最寬鬆，階段3最嚴格**，這樣才能確保系統正常運作！
