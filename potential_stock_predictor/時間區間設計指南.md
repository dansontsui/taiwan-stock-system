# 潛力股預測系統 - 時間區間設計指南

## 🎯 核心概念：時間序列機器學習的正確方法

### 基本原則
- **特徵資料**：用「過去」的資料作為輸入
- **目標變數**：用「未來」的結果作為標籤  
- **預測時點**：只能使用「當下」已知的資料

## 📅 1. 時間區間設計

### 正確的時間關係
```
時間軸: ←─────────────────────────────────────→
        2022年    2023年    2024年    2025年

訓練階段:
特徵資料: [2022-01-01 ─── 2024-03-31]  ← 歷史資料
目標變數: [2022-02-20 ─── 2024-04-30]  ← 未來20日結果
         ↑
         20個交易日的時間差

預測階段:
特徵資料: [2025-06-01]                  ← 當前已知資料
預測結果: [2025-07-01]                  ← 未來20日預測
```

### 重要時間差
- **特徵日期** → **目標日期**：間隔20個交易日
- **訓練期** → **預測期**：完全分離，不重疊

## 🔍 2. 具體應用場景

### 場景：預測2025年6月台積電是否會上漲

#### 步驟1：生成訓練用的特徵資料
```bash
# 生成2022-2024年的特徵資料（用於訓練）
python main.py generate-features --date 2024-03-31 --stock-ids 2330
python main.py generate-features --date 2024-06-30 --stock-ids 2330
python main.py generate-features --date 2023-12-31 --stock-ids 2330

# 或使用批次處理（推薦）
python main.py generate-features --date 2024-03-31
python main.py generate-features --date 2024-06-30
```

#### 步驟2：生成訓練用的目標變數
```bash
# 生成2022-2024年的目標變數
python main.py generate-targets --start-date 2022-01-01 --end-date 2024-06-30 --frequency quarterly
```

#### 步驟3：訓練模型
```bash
# 使用歷史資料訓練模型
python main.py train-models --features data/features/features_2024-06-30.csv --targets data/targets/targets_quarterly_2024-06-30.csv
```

#### 步驟4：生成預測用的特徵資料
```bash
# 生成2025年6月的特徵資料（用於預測）
python main.py generate-features --date 2025-06-01 --stock-ids 2330
```

#### 步驟5：執行預測
```bash
# 預測2025年6月台積電的表現
python main.py predict --stock-id 2330 --date 2025-06-01
```

## 📊 3. 完整的時間設計範例

### 訓練資料設計
```
特徵資料日期範圍：
├── 2022-03-31 (Q1)
├── 2022-06-30 (Q2)  
├── 2022-09-30 (Q3)
├── 2022-12-31 (Q4)
├── 2023-03-31 (Q1)
├── 2023-06-30 (Q2)
├── 2023-09-30 (Q3)
├── 2023-12-31 (Q4)
├── 2024-03-31 (Q1)
└── 2024-06-30 (Q2)

目標變數對應：
├── 2022-03-31 → 2022-04-28 (20個交易日後)
├── 2022-06-30 → 2022-07-28
├── 2022-09-30 → 2022-10-28
└── ... 以此類推
```

### 避免未來函數的關鍵
```
❌ 錯誤做法：
特徵日期：2024-06-30
目標日期：2024-05-30  ← 用過去預測更過去（邏輯錯誤）

✅ 正確做法：
特徵日期：2024-06-30
目標日期：2024-07-30  ← 用過去預測未來
```

## 🛠️ 4. 實際操作命令

### 完整訓練流程
```bash
cd potential_stock_predictor

# 1. 生成歷史特徵資料（訓練用）
echo "生成2022-2024年特徵資料..."
python main.py generate-features --date 2022-03-31
python main.py generate-features --date 2022-06-30  
python main.py generate-features --date 2022-09-30
python main.py generate-features --date 2022-12-31
python main.py generate-features --date 2023-03-31
python main.py generate-features --date 2023-06-30
python main.py generate-features --date 2023-09-30
python main.py generate-features --date 2023-12-31
python main.py generate-features --date 2024-03-31
python main.py generate-features --date 2024-06-30

# 2. 生成對應的目標變數
echo "生成目標變數..."
python main.py generate-targets --start-date 2022-01-01 --end-date 2024-06-30 --frequency quarterly

# 3. 訓練模型
echo "訓練模型..."
python main.py train-models --features data/features/features_2024-06-30.csv --targets data/targets/targets_quarterly_2024-06-30.csv

# 4. 生成當前特徵（預測用）
echo "生成2025年6月特徵..."
python main.py generate-features --date 2025-06-01

# 5. 執行預測
echo "預測台積電..."
python main.py predict --stock-id 2330 --date 2025-06-01
```

### 使用選單系統
```
1. 選擇 2 (資料處理)
2. 選擇 2 (生成特徵資料 完整版)
   - 日期：2024-06-30
   - 股票：留空（所有股票）

3. 選擇 3 (生成目標變數)
   - 開始日期：2022-01-01
   - 結束日期：2024-06-30
   - 頻率：quarterly

4. 選擇 0 (返回主選單)
5. 選擇 3 (模型訓練)
6. 選擇 4 (執行預測)
```

## ⚠️ 5. 常見錯誤和注意事項

### 錯誤1：時間順序顛倒
```bash
❌ 錯誤：
特徵日期：2025-06-01
目標變數範圍：2022-01-01 到 2024-06-30
# 用未來預測過去！

✅ 正確：
目標變數範圍：2022-01-01 到 2024-06-30  ← 訓練用
特徵日期：2025-06-01                    ← 預測用
```

### 錯誤2：資料洩漏
```bash
❌ 錯誤：
訓練時使用2025年的資料預測2024年

✅ 正確：
只使用2024年之前的資料訓練模型
```

### 錯誤3：時間間隔不一致
```bash
❌ 錯誤：
訓練時用20日預測，實際預測用30日

✅ 正確：
訓練和預測都使用相同的20日間隔
```

## 📈 6. 最佳實踐建議

### 資料分割策略
```
總資料：2020-2025年

訓練集：2020-2023年 (70%)
驗證集：2024年上半年 (15%)  
測試集：2024年下半年 (15%)
預測：2025年
```

### 滾動窗口訓練
```bash
# 每季度重新訓練模型
python main.py generate-features --date 2025-03-31
python main.py train-models --features data/features/features_2025-03-31.csv
python main.py predict --date 2025-06-01
```

### 模型更新頻率
- **特徵生成**：每月或每季
- **模型重訓**：每季度
- **預測執行**：每日或每週

## 🎯 7. 關鍵檢查清單

在執行預測前，請確認：

- [ ] 特徵資料使用的是歷史資料（過去）
- [ ] 目標變數使用的是未來20日結果
- [ ] 訓練期和預測期完全分離
- [ ] 沒有使用未來資料訓練模型
- [ ] 時間間隔保持一致（都是20個交易日）
- [ ] 資料日期邏輯正確（特徵日期 < 目標日期）

---

**記住：永遠用過去預測未來，絕不用未來預測過去！**

這樣的設計確保了：
1. **時間邏輯正確**：永遠用過去預測未來
2. **避免資料洩漏**：訓練時看不到未來資料  
3. **實用性強**：符合實際投資決策流程
