# 📅 台股每日增量資料收集功能

## 🎯 功能概述

每日增量資料收集功能是台股潛力股分析系統的重要組成部分，能夠自動檢測並收集從上次更新到今日的增量資料，確保資料庫始終保持最新狀態。

## ✨ 主要特色

- 🤖 **智能檢測**: 自動檢測各類資料的最後更新時間
- 📊 **增量收集**: 只收集缺失的日期範圍，避免重複
- ⏰ **智能等待**: 遇到402錯誤自動等待70分鐘
- 📈 **進度追蹤**: 詳細的執行日誌和統計資訊
- 🌐 **Web整合**: 在Web介面中顯示每日更新狀態

## 🚀 快速開始

### 方式一：使用主要腳本

```bash
# 基本執行
python scripts/collect_daily_update.py

# 自訂參數執行
python scripts/collect_daily_update.py --batch-size 5 --days-back 7
```

### 方式二：使用快速腳本

```bash
# 簡化執行
python daily_update.py
```

### 方式三：在Web介面中執行

1. 訪問 http://localhost:8501
2. 點擊「⚙️ 系統狀態」頁面
3. 在「📅 每日更新狀態」區域點擊「🚀 執行每日更新」按鈕

## 📊 收集範圍

### 1. 股價資料
- **檢測邏輯**: 從最後收集日期到今日
- **收集條件**: 如果有缺失的交易日資料
- **批次大小**: 使用指定的batch-size參數

### 2. 月營收資料
- **檢測邏輯**: 檢查上個月的資料完整性
- **收集條件**: 如果上個月資料少於100檔股票
- **更新頻率**: 每月檢查一次

### 3. 財務報表資料
- **檢測邏輯**: 檢查當年度的財務報表完整性
- **收集條件**: 在財報公布期間（每季度第二個月後）
- **更新頻率**: 季度檢查

### 4. 股利政策資料
- **檢測邏輯**: 檢查當年度的股利政策資料
- **收集條件**: 在股利公布期間（3-8月）
- **更新頻率**: 年度檢查

## ⚙️ 參數說明

### 命令列參數

| 參數 | 預設值 | 說明 |
|------|--------|------|
| `--batch-size` | 5 | 批次大小，控制同時處理的股票數量 |
| `--days-back` | 7 | 往前檢查天數，確保資料完整性 |

### 使用範例

```bash
# 使用較小批次大小（適合API限制較嚴格時）
python scripts/collect_daily_update.py --batch-size 3

# 檢查更多天數的資料
python scripts/collect_daily_update.py --days-back 14

# 組合參數
python scripts/collect_daily_update.py --batch-size 3 --days-back 10
```

## 🔧 智能功能

### 1. 自動檢測機制

```python
# 股價資料檢測
last_date = get_last_update_date('stock_prices', 'date')
start_date = last_date + timedelta(days=1)

# 月營收資料檢測
current_month = today.replace(day=1)
last_month = (current_month - timedelta(days=1)).replace(day=1)
```

### 2. 智能等待機制

- **自動檢測**: 檢測402 API限制錯誤
- **智能等待**: 自動等待70分鐘後重試
- **進度顯示**: 顯示等待進度和剩餘時間
- **日誌記錄**: 詳細記錄等待過程

### 3. 錯誤處理

- **重試機制**: 自動重試失敗的請求
- **錯誤日誌**: 詳細記錄錯誤資訊
- **狀態追蹤**: 追蹤每個收集階段的狀態

## 📈 監控與狀態

### 1. 命令列監控

```bash
# 啟動監控程序
python monitor_collection.py
```

監控程序會顯示：
- 📅 每日更新狀態
- 📊 今日/昨日股價資料統計
- 💡 執行建議

### 2. Web介面監控

在「⚙️ 系統狀態」頁面中查看：
- 📅 **每日更新狀態**: 顯示最後更新時間和狀態
- 📊 **資料統計**: 今日和昨日的資料量對比
- 🚀 **一鍵執行**: 直接在Web介面執行每日更新

### 3. 日誌檢查

```bash
# 查看每日更新日誌
tail -f logs/collect_daily_update.log

# 查看最近的執行記錄
tail -20 logs/collect_daily_update.log
```

## 📋 執行流程

### 完整執行流程

1. **初始化檢查**
   - 檢查資料庫連接
   - 設定日誌記錄
   - 初始化統計資料

2. **股價資料收集**
   - 檢測最後更新日期
   - 計算需要收集的日期範圍
   - 執行增量收集

3. **月營收資料收集**
   - 檢查上個月資料完整性
   - 如需要則執行收集

4. **財務報表收集**
   - 檢查是否在財報公布期間
   - 檢查當年度資料完整性
   - 如需要則執行收集

5. **股利政策收集**
   - 檢查是否在股利公布期間
   - 檢查當年度資料完整性
   - 如需要則執行收集

6. **潛力股分析更新**
   - 重新計算潛力股評分
   - 更新分析結果

7. **統計摘要**
   - 顯示執行時間
   - 統計新增資料量
   - 記錄執行結果

## 🕐 建議執行時間

### 每日執行

```bash
# 建議在每日收盤後執行（晚上7點後）
0 19 * * 1-5 cd /path/to/taiwan_stock_system && python daily_update.py
```

### 週末執行

```bash
# 週末執行完整檢查
0 10 * * 6 cd /path/to/taiwan_stock_system && python scripts/collect_daily_update.py --days-back 14
```

## 🔍 故障排除

### 常見問題

1. **402 API限制錯誤**
   - **現象**: 收集中斷，顯示402錯誤
   - **解決**: 系統會自動等待70分鐘後重試

2. **資料庫鎖定錯誤**
   - **現象**: database is locked
   - **解決**: 確保沒有其他程序在使用資料庫

3. **網路連線問題**
   - **現象**: 連線超時
   - **解決**: 檢查網路連線，系統會自動重試

### 日誌檢查

```bash
# 檢查執行狀態
grep "每日增量收集" logs/collect_daily_update.log

# 檢查錯誤資訊
grep "ERROR\|❌" logs/collect_daily_update.log

# 檢查統計資訊
grep "資料更新統計" logs/collect_daily_update.log
```

## 💡 最佳實踐

### 1. 定時執行

- **每日執行**: 在收盤後（晚上7點後）執行
- **週末檢查**: 執行較完整的資料檢查
- **月初執行**: 重點檢查月營收資料

### 2. 參數調整

- **API限制嚴格時**: 使用較小的batch-size (3)
- **網路不穩定時**: 增加days-back參數確保完整性
- **首次執行**: 使用較大的days-back參數

### 3. 監控建議

- **定期檢查日誌**: 確保執行正常
- **監控資料量**: 注意異常的資料量變化
- **Web介面檢查**: 定期查看系統狀態頁面

## 🎉 總結

每日增量資料收集功能提供了：

✅ **自動化**: 無需手動干預的增量更新  
✅ **智能化**: 自動檢測和處理各種情況  
✅ **可靠性**: 完善的錯誤處理和重試機制  
✅ **可視化**: Web介面整合和監控功能  
✅ **靈活性**: 多種執行方式和參數配置  

**立即開始使用每日更新功能，保持您的台股資料庫始終最新！** 🚀📈💎
