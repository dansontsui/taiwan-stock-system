#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n"""\nè³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†è…³æœ¬\n"""\n\nimport sys\nimport os\nimport time\nimport argparse\nimport warnings\nfrom datetime import datetime, timedelta\nimport pandas as pd\n# from tqdm import tqdm  # æš«æ™‚è¨»è§£æ‰é¿å…ä¾è³´å•é¡Œ\n\n# éš±è— DeprecationWarning\nwarnings.filterwarnings("ignore", category=DeprecationWarning)\n\n# æ·»åŠ å°ˆæ¡ˆæ ¹ç›®éŒ„åˆ° Python è·¯å¾‘\nsys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n\nfrom config import Config\nfrom app.utils.simple_database import SimpleDatabaseManager as DatabaseManager\nfrom app.services.data_collector import FinMindDataCollector\nfrom loguru import logger\n\n# ç°¡åŒ–çš„APIç‹€æ…‹æª¢æŸ¥\ndef is_api_limit_error(error_msg):\n    """æª¢æŸ¥æ˜¯å¦ç‚ºAPIé™åˆ¶éŒ¯èª¤"""\n    api_limit_keywords = ["402", "Payment Required", "APIè«‹æ±‚é™åˆ¶", "rate limit", "quota exceeded"]\n    return any(keyword.lower() in error_msg.lower() for keyword in api_limit_keywords)\n\ndef wait_for_api_recovery(stock_id="2330", dataset="TaiwanStockPrice"):\n    """ç­‰å¾…APIæ¢å¾©æ­£å¸¸ - æ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡"""\n    import requests\n    from datetime import datetime, timedelta\n    \n    print("=" * 60)\n    print("ğŸš« APIè«‹æ±‚é™åˆ¶åµæ¸¬ - é–‹å§‹æ¯5åˆ†é˜æª¢æŸ¥APIç‹€æ…‹")\n    print("=" * 60)\n    \n    check_count = 0\n    while True:\n        check_count += 1\n        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n        print(f"â° [{current_time}] ç¬¬ {check_count} æ¬¡æª¢æŸ¥APIç‹€æ…‹...")\n        \n        try:\n            # ä½¿ç”¨ç°¡å–®çš„APIè«‹æ±‚æ¸¬è©¦ç‹€æ…‹\n            test_url = "https://api.finmindtrade.com/api/v4/data"\n            yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')\n            \n            test_params = {\n                "dataset": dataset,\n                "data_id": stock_id,\n                "start_date": yesterday,\n                "end_date": yesterday,\n                "token": ""  # ä½¿ç”¨å…è²»é¡åº¦æ¸¬è©¦\n            }\n            \n            response = requests.get(test_url, params=test_params, timeout=10)\n            \n            if response.status_code == 200:\n                print(f"âœ… [{datetime.now().strftime('%H:%M:%S')}] APIå·²æ¢å¾©æ­£å¸¸ï¼Œç¹¼çºŒåŸ·è¡Œ")\n                print("=" * 60)\n                return True\n            elif response.status_code == 402:\n                print(f"âŒ APIä»ç„¶å—é™ (402)ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n            else:\n                print(f"âš ï¸ APIç‹€æ…‹ç¢¼: {response.status_code}ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n                \n        except Exception as e:\n            print(f"âš ï¸ æª¢æŸ¥APIç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n        \n        # ç­‰å¾…5åˆ†é˜\n        print("â³ ç­‰å¾…5åˆ†é˜...")\n        for i in range(5):\n            remaining = 5 - i\n            print(f"\r   å‰©é¤˜ {remaining} åˆ†é˜...", end="", flush=True)\n            time.sleep(60)\n        print()  # æ›è¡Œ\n\ndef init_logging():\n    """åˆå§‹åŒ–æ—¥èªŒ"""\n    log_dir = os.path.join(Config.BASE_DIR, 'logs')\n    if not os.path.exists(log_dir):\n        os.makedirs(log_dir)\n    \n    logger.add(\n        os.path.join(log_dir, 'collect_balance_sheets.log'),\n        rotation="50 MB",\n        retention="30 days",\n        level="INFO"\n    )\n\ndef get_balance_sheet_data(collector, stock_id, start_date, end_date):\n    """ç²å–è³‡ç”¢è² å‚µè¡¨è³‡æ–™"""\n    try:\n        data = collector._make_request(\n            dataset="TaiwanStockBalanceSheet",\n            data_id=stock_id,\n            start_date=start_date,\n            end_date=end_date\n        )\n        \n        if data and 'data' in data and data['data']:\n            df = pd.DataFrame(data['data'])\n            logger.info(f"è‚¡ç¥¨ {stock_id} ç²å–åˆ° {len(df)} ç­†è³‡ç”¢è² å‚µè¡¨è³‡æ–™")\n            return df\n        else:\n            logger.warning(f"è‚¡ç¥¨ {stock_id} ç„¡è³‡ç”¢è² å‚µè¡¨è³‡æ–™")\n            return None\n            \n    except Exception as e:\n        error_msg = str(e)\n        if "402" in error_msg or "Payment Required" in error_msg:\n            raise Exception(f"APIè«‹æ±‚é™åˆ¶: {error_msg}")\n        logger.error(f"ç²å–è‚¡ç¥¨ {stock_id} è³‡ç”¢è² å‚µè¡¨è³‡æ–™å¤±æ•—: {e}")\n        return None\n\ndef save_balance_sheet_data(db_manager, df, stock_id):\n    """å„²å­˜è³‡ç”¢è² å‚µè¡¨è³‡æ–™"""\n    if df is None or df.empty:\n        return 0\n    \n    conn = db_manager.get_connection()\n    cursor = conn.cursor()\n    \n    saved_count = 0\n    \n    try:\n        for _, row in df.iterrows():\n            try:\n                cursor.execute("""\n                    INSERT OR REPLACE INTO balance_sheets \n                    (stock_id, date, type, value, origin_name, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                """, (\n                    row['stock_id'],\n                    row['date'],\n                    row['type'],\n                    row['value'],\n                    row.get('origin_name', ''),\n                    datetime.now()\n                ))\n                saved_count += 1\n                \n            except Exception as e:\n                logger.warning(f"å„²å­˜è³‡ç”¢è² å‚µè¡¨è³‡æ–™å¤±æ•— {stock_id} {row.get('date', 'N/A')} {row.get('type', 'N/A')}: {e}")\n                continue\n        \n        conn.commit()\n        logger.info(f"è‚¡ç¥¨ {stock_id} æˆåŠŸå„²å­˜ {saved_count} ç­†è³‡ç”¢è² å‚µè¡¨è³‡æ–™")\n        \n    except Exception as e:\n        logger.error(f"å„²å­˜è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")\n        conn.rollback()\n        \n    finally:\n        conn.close()\n    \n    return saved_count\n\ndef calculate_balance_sheet_ratios(db_manager, stock_id):\n    """è¨ˆç®—è³‡ç”¢è² å‚µè¡¨ç›¸é—œæ¯”ç‡"""\n    conn = db_manager.get_connection()\n    cursor = conn.cursor()\n    \n    try:\n        cursor.execute("""\n            SELECT date, type, value\n            FROM balance_sheets \n            WHERE stock_id = ?\n            ORDER BY date, type\n        """, (stock_id,))\n        \n        data = cursor.fetchall()\n        \n        if not data:\n            return 0\n        \n        # æŒ‰æ—¥æœŸåˆ†çµ„è™•ç†\n        date_groups = {}\n        for date, type_name, value in data:\n            if date not in date_groups:\n                date_groups[date] = {}\n            date_groups[date][type_name] = value\n        \n        updated_count = 0\n        \n        for date, metrics in date_groups.items():\n            # è¨ˆç®—é—œéµè²¡å‹™æ¯”ç‡\n            total_assets = metrics.get('TotalAssets', 0)\n            total_liabilities = metrics.get('TotalLiabilities', 0)\n            current_assets = metrics.get('CurrentAssets', 0)\n            current_liabilities = metrics.get('CurrentLiabilities', 0)\n            \n            # è¨ˆç®—æ¯”ç‡\n            debt_ratio = None\n            current_ratio = None\n            \n            if total_assets and total_assets > 0:\n                if total_liabilities:\n                    debt_ratio = (total_liabilities / total_assets) * 100\n            \n            if current_liabilities and current_liabilities > 0:\n                if current_assets:\n                    current_ratio = current_assets / current_liabilities\n            \n            # æ›´æ–°è²¡å‹™æ¯”ç‡è¡¨\n            if debt_ratio is not None or current_ratio is not None:\n                cursor.execute("""\n                    INSERT OR REPLACE INTO financial_ratios \n                    (stock_id, date, debt_ratio, current_ratio, created_at)\n                    VALUES (?, ?, ?, ?, ?)\n                    ON CONFLICT(stock_id, date) DO UPDATE SET\n                    debt_ratio = COALESCE(excluded.debt_ratio, debt_ratio),\n                    current_ratio = COALESCE(excluded.current_ratio, current_ratio)\n                """, (\n                    stock_id, date, debt_ratio, current_ratio, datetime.now()\n                ))\n                updated_count += 1\n        \n        conn.commit()\n        logger.info(f"è‚¡ç¥¨ {stock_id} è³‡ç”¢è² å‚µè¡¨æ¯”ç‡è¨ˆç®—å®Œæˆï¼Œæ›´æ–° {updated_count} ç­†è¨˜éŒ„")\n        return updated_count\n        \n    except Exception as e:\n        logger.error(f"è¨ˆç®—è³‡ç”¢è² å‚µè¡¨æ¯”ç‡å¤±æ•— {stock_id}: {e}")\n        conn.rollback()\n        return 0\n    finally:\n        conn.close()\n\ndef collect_balance_sheet_batch(stock_list, start_date, end_date, batch_size=3):\n    """æ‰¹æ¬¡æ”¶é›†è³‡ç”¢è² å‚µè¡¨è³‡æ–™"""\n    print(f" é–‹å§‹æ”¶é›†è³‡ç”¢è² å‚µè¡¨è³‡æ–™")\n    print(f" æ—¥æœŸç¯„åœ: {start_date} ~ {end_date}")\n    print(f" è‚¡ç¥¨æ•¸é‡: {len(stock_list)}")\n    print(f" æ‰¹æ¬¡å¤§å°: {batch_size}")\n    print("=" * 60)\n    \n    db_manager = DatabaseManager(Config.DATABASE_PATH)\n    collector = FinMindDataCollector(\n        api_url=Config.FINMIND_API_URL,\n        api_token=Config.FINMIND_API_TOKEN\n    )\n    \n    total_saved = 0\n    total_ratios = 0\n    failed_stocks = []\n    \n    total_batches = (len(stock_list) + batch_size - 1) // batch_size\n    for batch_idx, i in enumerate(range(0, len(stock_list), batch_size), 1):\n        batch = stock_list[i:i + batch_size]\n        print(f"è™•ç†æ‰¹æ¬¡ {batch_idx}/{total_batches} ({len(batch)} æª”è‚¡ç¥¨)")\n        \n        for stock in batch:\n            stock_id = stock['stock_id']\n            stock_name = stock.get('stock_name', stock_id)\n            \n            try:\n                print(f" æ”¶é›† {stock_id} ({stock_name}) è³‡ç”¢è² å‚µè¡¨è³‡æ–™...")\n                \n                df = get_balance_sheet_data(collector, stock_id, start_date, end_date)\n                \n                if df is not None and not df.empty:\n                    saved_count = save_balance_sheet_data(db_manager, df, stock_id)\n                    total_saved += saved_count\n                    \n                    ratio_count = calculate_balance_sheet_ratios(db_manager, stock_id)\n                    total_ratios += ratio_count\n                    \n                    print(f" {stock_id} å®Œæˆï¼Œå„²å­˜ {saved_count} ç­†è³‡æ–™ï¼Œè¨ˆç®— {ratio_count} ç­†æ¯”ç‡")\n                else:\n                    print(f"  {stock_id} ç„¡è³‡æ–™")\n                \n                time.sleep(2)\n\n            except KeyboardInterrupt:\n                print(f"\nâš ï¸ ä½¿ç”¨è€…ä¸­æ–·åŸ·è¡Œï¼Œå·²è™•ç† {processed_count}/{total_stocks} æª”è‚¡ç¥¨")\n                logger.info(f"ä½¿ç”¨è€…ä¸­æ–·åŸ·è¡Œï¼Œå·²è™•ç† {processed_count}/{total_stocks} æª”è‚¡ç¥¨")\n                break  # è·³å‡ºè¿´åœˆï¼Œè¿”å›å·²æ”¶é›†çš„çµæœ\n            except Exception as e:\n                error_msg = str(e)\n                print(f" {stock_id} å¤±æ•—: {error_msg}")\n                logger.error(f"æ”¶é›† {stock_id} è³‡ç”¢è² å‚µè¡¨å¤±æ•—: {error_msg}")\n                failed_stocks.append((stock_id, error_msg))\n                \n                # å¦‚æœæ˜¯APIé™åˆ¶éŒ¯èª¤ï¼Œæ™ºèƒ½ç­‰å¾…\n                if is_api_limit_error(error_msg):\n                    wait_for_api_recovery(stock_id, dataset)\n                else:\n                    time.sleep(5)\n        \n        if i + batch_size < len(stock_list):\n            print(f"  æ‰¹æ¬¡å®Œæˆï¼Œä¼‘æ¯15ç§’...")\n            time.sleep(15)\n    \n    print("\n" + "=" * 60)\n    print(" è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†å®Œæˆ")\n    print("=" * 60)\n    print(f" æˆåŠŸæ”¶é›†: {len(stock_list) - len(failed_stocks)} æª”è‚¡ç¥¨")\n    print(f" ç¸½å„²å­˜ç­†æ•¸: {total_saved}")\n    print(f" è²¡å‹™æ¯”ç‡ç­†æ•¸: {total_ratios}")\n    print(f" å¤±æ•—è‚¡ç¥¨: {len(failed_stocks)} æª”")\n    \n    return total_saved, total_ratios, failed_stocks\n\ndef main():\n    """ä¸»å‡½æ•¸"""\n    # ç¢ºä¿ datetime åœ¨å‡½æ•¸ä½œç”¨åŸŸä¸­å¯ç”¨\n    from datetime import datetime as dt\n\n    parser = argparse.ArgumentParser(description='æ”¶é›†å°è‚¡è³‡ç”¢è² å‚µè¡¨è³‡æ–™')\n    parser.add_argument('--start-date', default='2020-01-01', help='é–‹å§‹æ—¥æœŸ')\n    parser.add_argument('--end-date', default=dt.now().strftime('%Y-%m-%d'), help='çµæŸæ—¥æœŸ')\n    parser.add_argument('--batch-size', type=int, default=3, help='æ‰¹æ¬¡å¤§å°')\n    parser.add_argument('--test', action='store_true', help='æ¸¬è©¦æ¨¡å¼')\n    parser.add_argument('--stock-id', help='æŒ‡å®šè‚¡ç¥¨ä»£ç¢¼')\n\n    args = parser.parse_args()\n\n    print("=" * 60)\n    if args.stock_id:\n        print(f"å°è‚¡è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†ç³»çµ± - å€‹è‚¡ {args.stock_id}")\n    else:\n        print("å°è‚¡è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†ç³»çµ±")\n    print("=" * 60)\n\n    init_logging()\n    logger.info("é–‹å§‹æ”¶é›†è³‡ç”¢è² å‚µè¡¨è³‡æ–™")\n\n    # ä¸å†é å…ˆåˆå§‹åŒ–è¨ˆæ™‚å™¨ï¼Œåªåœ¨é‡åˆ°APIé™åˆ¶æ™‚æ‰é–‹å§‹æª¢æŸ¥\n\n    try:\n        db_manager = DatabaseManager(Config.DATABASE_PATH)\n        conn = db_manager.get_connection()\n        cursor = conn.cursor()\n\n        if args.stock_id:\n            # æŒ‡å®šå€‹è‚¡\n            cursor.execute("""\n                SELECT stock_id, stock_name\n                FROM stocks\n                WHERE stock_id = ?\n            """, (args.stock_id,))\n            stock_list = [{'stock_id': row[0], 'stock_name': row[1]} for row in cursor.fetchall()]\n        else:\n            cursor.execute("""\n                SELECT stock_id, stock_name\n                FROM stocks\n                WHERE is_etf = 0\n                AND LENGTH(stock_id) = 4\n                AND stock_id GLOB '[0-9][0-9][0-9][0-9]'\n                AND market IN ('TWSE', 'TPEx')\n                ORDER BY stock_id\n            """)\n            stock_list = [{'stock_id': row[0], 'stock_name': row[1]} for row in cursor.fetchall()]\n\n        conn.close()\n\n        if args.test and not args.stock_id:\n            stock_list = stock_list[:3]\n            print(" æ¸¬è©¦æ¨¡å¼ï¼šåªæ”¶é›†å‰3æª”è‚¡ç¥¨")\n\n        if not stock_list:\n            if args.stock_id:\n                print(f" æ‰¾ä¸åˆ°è‚¡ç¥¨ä»£ç¢¼: {args.stock_id}")\n            else:\n                print(" æœªæ‰¾åˆ°è‚¡ç¥¨è³‡æ–™")\n            return\n        \n        total_saved, total_ratios, failed_stocks = collect_balance_sheet_batch(\n            stock_list=stock_list,\n            start_date=args.start_date,\n            end_date=args.end_date,\n            batch_size=args.batch_size\n        )\n        \n        logger.info(f"è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†å®Œæˆï¼Œå…±å„²å­˜ {total_saved} ç­†è³‡æ–™ï¼Œè¨ˆç®— {total_ratios} ç­†æ¯”ç‡")\n\n    except KeyboardInterrupt:\n        print(f"\nâš ï¸ è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†å·²è¢«ä½¿ç”¨è€…ä¸­æ–·")\n        logger.info("è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†å·²è¢«ä½¿ç”¨è€…ä¸­æ–·")\n        sys.exit(0)  # æ­£å¸¸é€€å‡ºï¼Œä¸æ˜¯éŒ¯èª¤\n    except Exception as e:\n        error_msg = f"è³‡ç”¢è² å‚µè¡¨è³‡æ–™æ”¶é›†å¤±æ•—: {e}"\n        print(f" {error_msg}")\n        logger.error(error_msg)\n        sys.exit(1)\n\nif __name__ == "__main__":\n    main()\n