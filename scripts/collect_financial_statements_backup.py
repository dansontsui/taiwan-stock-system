#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n"""\nç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†è…³æœ¬\n"""\n\nimport sys\nimport os\nimport time\nimport argparse\nimport warnings\nfrom datetime import datetime, timedelta\nimport pandas as pd\n# from tqdm import tqdm  # æš«æ™‚è¨»è§£æ‰é¿å…ä¾è³´å•é¡Œ\n\n# éš±è— DeprecationWarning\nwarnings.filterwarnings("ignore", category=DeprecationWarning)\n\n# æ·»åŠ å°ˆæ¡ˆæ ¹ç›®éŒ„åˆ° Python è·¯å¾‘\nsys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n\nfrom config import Config\nfrom app.utils.simple_database import SimpleDatabaseManager as DatabaseManager\nfrom app.services.data_collector import FinMindDataCollector\nfrom loguru import logger\n\n# ç°¡åŒ–çš„APIç‹€æ…‹æª¢æŸ¥\ndef is_api_limit_error(error_msg):\n    """æª¢æŸ¥æ˜¯å¦ç‚ºAPIé™åˆ¶éŒ¯èª¤"""\n    api_limit_keywords = ["402", "Payment Required", "APIè«‹æ±‚é™åˆ¶", "rate limit", "quota exceeded"]\n    return any(keyword.lower() in error_msg.lower() for keyword in api_limit_keywords)\n\ndef wait_for_api_recovery(stock_id="2330", dataset="TaiwanStockPrice"):\n    """ç­‰å¾…APIæ¢å¾©æ­£å¸¸ - æ¯5åˆ†é˜æª¢æŸ¥ä¸€æ¬¡"""\n    import requests\n    from datetime import datetime, timedelta\n    \n    print("=" * 60)\n    print("ğŸš« APIè«‹æ±‚é™åˆ¶åµæ¸¬ - é–‹å§‹æ¯5åˆ†é˜æª¢æŸ¥APIç‹€æ…‹")\n    print("=" * 60)\n    \n    check_count = 0\n    while True:\n        check_count += 1\n        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n        print(f"â° [{current_time}] ç¬¬ {check_count} æ¬¡æª¢æŸ¥APIç‹€æ…‹...")\n        \n        try:\n            # ä½¿ç”¨ç°¡å–®çš„APIè«‹æ±‚æ¸¬è©¦ç‹€æ…‹\n            test_url = "https://api.finmindtrade.com/api/v4/data"\n            yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')\n            \n            test_params = {\n                "dataset": dataset,\n                "data_id": stock_id,\n                "start_date": yesterday,\n                "end_date": yesterday,\n                "token": ""  # ä½¿ç”¨å…è²»é¡åº¦æ¸¬è©¦\n            }\n            \n            response = requests.get(test_url, params=test_params, timeout=10)\n            \n            if response.status_code == 200:\n                print(f"âœ… [{datetime.now().strftime('%H:%M:%S')}] APIå·²æ¢å¾©æ­£å¸¸ï¼Œç¹¼çºŒåŸ·è¡Œ")\n                print("=" * 60)\n                return True\n            elif response.status_code == 402:\n                print(f"âŒ APIä»ç„¶å—é™ (402)ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n            else:\n                print(f"âš ï¸ APIç‹€æ…‹ç¢¼: {response.status_code}ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n                \n        except Exception as e:\n            print(f"âš ï¸ æª¢æŸ¥APIç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}ï¼Œ5åˆ†é˜å¾Œå†æ¬¡æª¢æŸ¥...")\n        \n        # ç­‰å¾…5åˆ†é˜\n        print("â³ ç­‰å¾…5åˆ†é˜...")\n        for i in range(5):\n            remaining = 5 - i\n            print(f"\r   å‰©é¤˜ {remaining} åˆ†é˜...", end="", flush=True)\n            time.sleep(60)\n        print()  # æ›è¡Œ\n\ndef init_logging():\n    """åˆå§‹åŒ–æ—¥èªŒ"""\n    log_dir = os.path.join(Config.BASE_DIR, 'logs')\n    if not os.path.exists(log_dir):\n        os.makedirs(log_dir)\n\n    logger.add(\n        os.path.join(log_dir, 'collect_financial_statements.log'),\n        rotation="50 MB",\n        retention="30 days",\n        level="INFO"\n    )\n\ndef get_financial_statements_data(collector, stock_id, start_date, end_date):\n    """ç²å–å–®ä¸€è‚¡ç¥¨çš„ç¶œåˆæç›Šè¡¨è³‡æ–™"""\n    try:\n        # ä½¿ç”¨FinMind APIç²å–ç¶œåˆæç›Šè¡¨è³‡æ–™\n        data = collector._make_request(\n            dataset="TaiwanStockFinancialStatements",\n            data_id=stock_id,\n            start_date=start_date,\n            end_date=end_date\n        )\n        \n        if data and 'data' in data and data['data']:\n            df = pd.DataFrame(data['data'])\n            logger.info(f"è‚¡ç¥¨ {stock_id} ç²å–åˆ° {len(df)} ç­†ç¶œåˆæç›Šè¡¨è³‡æ–™")\n            return df\n        else:\n            logger.warning(f"è‚¡ç¥¨ {stock_id} ç„¡ç¶œåˆæç›Šè¡¨è³‡æ–™")\n            return None\n            \n    except Exception as e:\n        logger.error(f"ç²å–è‚¡ç¥¨ {stock_id} ç¶œåˆæç›Šè¡¨è³‡æ–™å¤±æ•—: {e}")\n        return None\n\ndef save_financial_statements_data(db_manager, df, stock_id):\n    """å„²å­˜ç¶œåˆæç›Šè¡¨è³‡æ–™åˆ°è³‡æ–™åº«"""\n    if df is None or df.empty:\n        return 0\n    \n    conn = db_manager.get_connection()\n    cursor = conn.cursor()\n    \n    saved_count = 0\n    \n    try:\n        for _, row in df.iterrows():\n            try:\n                cursor.execute("""\n                    INSERT OR REPLACE INTO financial_statements \n                    (stock_id, date, type, value, origin_name, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                """, (\n                    row['stock_id'],\n                    row['date'],\n                    row['type'],\n                    row['value'],\n                    row.get('origin_name', ''),\n                    datetime.now()\n                ))\n                saved_count += 1\n                \n            except Exception as e:\n                logger.warning(f"å„²å­˜ç¶œåˆæç›Šè¡¨è³‡æ–™å¤±æ•— {stock_id} {row.get('date', 'N/A')} {row.get('type', 'N/A')}: {e}")\n                continue\n        \n        conn.commit()\n        logger.info(f"è‚¡ç¥¨ {stock_id} æˆåŠŸå„²å­˜ {saved_count} ç­†ç¶œåˆæç›Šè¡¨è³‡æ–™")\n        \n    except Exception as e:\n        logger.error(f"å„²å­˜ç¶œåˆæç›Šè¡¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")\n        conn.rollback()\n        \n    finally:\n        conn.close()\n    \n    return saved_count\n\ndef calculate_financial_ratios(db_manager, stock_id):\n    """è¨ˆç®—è²¡å‹™æ¯”ç‡"""\n    conn = db_manager.get_connection()\n    cursor = conn.cursor()\n    \n    try:\n        # ç²å–è©²è‚¡ç¥¨çš„ç¶œåˆæç›Šè¡¨è³‡æ–™ï¼ŒæŒ‰æ—¥æœŸåˆ†çµ„\n        cursor.execute("""\n            SELECT date, type, value\n            FROM financial_statements \n            WHERE stock_id = ?\n            ORDER BY date, type\n        """, (stock_id,))\n        \n        data = cursor.fetchall()\n        \n        if not data:\n            return 0\n        \n        # æŒ‰æ—¥æœŸåˆ†çµ„è™•ç†\n        date_groups = {}\n        for date, type_name, value in data:\n            if date not in date_groups:\n                date_groups[date] = {}\n            date_groups[date][type_name] = value\n        \n        updated_count = 0\n        \n        for date, metrics in date_groups.items():\n            # è¨ˆç®—é—œéµè²¡å‹™æ¯”ç‡\n            revenue = metrics.get('Revenue', 0)\n            cost_of_goods = metrics.get('CostOfGoodsSold', 0)\n            gross_profit = metrics.get('GrossProfit', 0)\n            operating_income = metrics.get('OperatingIncome', 0)\n            net_income = metrics.get('IncomeAfterTaxes', 0)\n            \n            # è¨ˆç®—æ¯”ç‡\n            gross_margin = None\n            operating_margin = None\n            net_margin = None\n            \n            if revenue and revenue > 0:\n                if gross_profit:\n                    gross_margin = (gross_profit / revenue) * 100\n                if operating_income:\n                    operating_margin = (operating_income / revenue) * 100\n                if net_income:\n                    net_margin = (net_income / revenue) * 100\n            \n            # å„²å­˜åˆ°è²¡å‹™æ¯”ç‡è¡¨\n            if any([gross_margin, operating_margin, net_margin]):\n                cursor.execute("""\n                    INSERT OR REPLACE INTO financial_ratios \n                    (stock_id, date, gross_margin, operating_margin, net_margin, created_at)\n                    VALUES (?, ?, ?, ?, ?, ?)\n                """, (\n                    stock_id, date, gross_margin, operating_margin, net_margin, datetime.now()\n                ))\n                updated_count += 1\n        \n        conn.commit()\n        logger.info(f"è‚¡ç¥¨ {stock_id} è²¡å‹™æ¯”ç‡è¨ˆç®—å®Œæˆï¼Œæ›´æ–° {updated_count} ç­†è¨˜éŒ„")\n        return updated_count\n        \n    except Exception as e:\n        logger.error(f"è¨ˆç®—è²¡å‹™æ¯”ç‡å¤±æ•— {stock_id}: {e}")\n        conn.rollback()\n        return 0\n    finally:\n        conn.close()\n\ndef collect_financial_statements_batch(stock_list, start_date, end_date, batch_size=5):\n    """æ‰¹æ¬¡æ”¶é›†ç¶œåˆæç›Šè¡¨è³‡æ–™"""\n    print(f" é–‹å§‹æ”¶é›†ç¶œåˆæç›Šè¡¨è³‡æ–™")\n    print(f" æ—¥æœŸç¯„åœ: {start_date} ~ {end_date}")\n    print(f" è‚¡ç¥¨æ•¸é‡: {len(stock_list)}")\n    print(f" æ‰¹æ¬¡å¤§å°: {batch_size}")\n    print("=" * 60)\n    \n    # åˆå§‹åŒ–\n    db_manager = DatabaseManager(Config.DATABASE_PATH)\n    collector = FinMindDataCollector(\n        api_url=Config.FINMIND_API_URL,\n        api_token=Config.FINMIND_API_TOKEN\n    )\n    \n    total_saved = 0\n    total_ratios = 0\n    failed_stocks = []\n    \n    # åˆ†æ‰¹è™•ç†\n    total_batches = (len(stock_list) + batch_size - 1) // batch_size\n    for batch_idx, i in enumerate(range(0, len(stock_list), batch_size), 1):\n        batch = stock_list[i:i + batch_size]\n        print(f"è™•ç†æ‰¹æ¬¡ {batch_idx}/{total_batches} ({len(batch)} æª”è‚¡ç¥¨)")\n        \n        for stock in batch:\n            stock_id = stock['stock_id']\n            stock_name = stock.get('stock_name', stock_id)\n            \n            try:\n                print(f" æ”¶é›† {stock_id} ({stock_name}) ç¶œåˆæç›Šè¡¨è³‡æ–™...")\n                \n                # ç²å–ç¶œåˆæç›Šè¡¨è³‡æ–™\n                df = get_financial_statements_data(collector, stock_id, start_date, end_date)\n                \n                if df is not None and not df.empty:\n                    # å„²å­˜è³‡æ–™\n                    saved_count = save_financial_statements_data(db_manager, df, stock_id)\n                    total_saved += saved_count\n                    \n                    # è¨ˆç®—è²¡å‹™æ¯”ç‡\n                    ratio_count = calculate_financial_ratios(db_manager, stock_id)\n                    total_ratios += ratio_count\n                    \n                    print(f" {stock_id} å®Œæˆï¼Œå„²å­˜ {saved_count} ç­†è³‡æ–™ï¼Œè¨ˆç®— {ratio_count} ç­†æ¯”ç‡")\n                else:\n                    print(f"  {stock_id} ç„¡è³‡æ–™")\n                \n                # æ§åˆ¶è«‹æ±‚é »ç‡\n                time.sleep(1)\n                \n            except Exception as e:\n                error_msg = str(e)\n                print(f" {stock_id} å¤±æ•—: {error_msg}")\n                logger.error(f"æ”¶é›† {stock_id} ç¶œåˆæç›Šè¡¨å¤±æ•—: {error_msg}")\n                failed_stocks.append((stock_id, error_msg))\n                \n                # å¦‚æœæ˜¯APIé™åˆ¶éŒ¯èª¤ï¼Œæ™ºèƒ½ç­‰å¾…\n                if is_api_limit_error(error_msg):\n                    wait_for_api_recovery(stock_id, dataset)\n                else:\n                    time.sleep(3)\n        \n        # æ‰¹æ¬¡é–“ä¼‘æ¯\n        if i + batch_size < len(stock_list):\n            print(f"  æ‰¹æ¬¡å®Œæˆï¼Œä¼‘æ¯10ç§’...")\n            time.sleep(10)\n    \n    # é¡¯ç¤ºçµæœ\n    print("\n" + "=" * 60)\n    print(" ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†å®Œæˆ")\n    print("=" * 60)\n    print(f" æˆåŠŸæ”¶é›†: {len(stock_list) - len(failed_stocks)} æª”è‚¡ç¥¨")\n    print(f" ç¸½å„²å­˜ç­†æ•¸: {total_saved}")\n    print(f" è²¡å‹™æ¯”ç‡ç­†æ•¸: {total_ratios}")\n    print(f" å¤±æ•—è‚¡ç¥¨: {len(failed_stocks)} æª”")\n    \n    if failed_stocks:\n        print("\nå¤±æ•—è‚¡ç¥¨æ¸…å–®:")\n        for stock_id, error in failed_stocks[:10]:  # åªé¡¯ç¤ºå‰10å€‹\n            print(f"  {stock_id}: {error}")\n        if len(failed_stocks) > 10:\n            print(f"  ... é‚„æœ‰ {len(failed_stocks) - 10} æª”")\n    \n    return total_saved, total_ratios, failed_stocks\n\ndef show_sample_data(db_manager, limit=5):\n    """é¡¯ç¤ºç¯„ä¾‹è³‡æ–™"""\n    conn = db_manager.get_connection()\n    cursor = conn.cursor()\n    \n    try:\n        print("\n ç¶œåˆæç›Šè¡¨è³‡æ–™ç¯„ä¾‹:")\n        print("-" * 60)\n        \n        cursor.execute("""\n            SELECT stock_id, date, type, value, origin_name\n            FROM financial_statements \n            WHERE type IN ('Revenue', 'GrossProfit', 'OperatingIncome', 'IncomeAfterTaxes', 'EPS')\n            ORDER BY stock_id, date DESC, type\n            LIMIT ?\n        """, (limit * 5,))\n        \n        for row in cursor.fetchall():\n            stock_id, date, type_name, value, origin_name = row\n            print(f"{stock_id} {date} {type_name:<20} {value:>15,.0f} ({origin_name})")\n        \n        print("\n è²¡å‹™æ¯”ç‡è³‡æ–™ç¯„ä¾‹:")\n        print("-" * 60)\n        \n        cursor.execute("""\n            SELECT stock_id, date, gross_margin, operating_margin, net_margin\n            FROM financial_ratios \n            ORDER BY stock_id, date DESC\n            LIMIT ?\n        """, (limit,))\n        \n        for row in cursor.fetchall():\n            stock_id, date, gross_margin, operating_margin, net_margin = row\n            print(f"{stock_id} {date} æ¯›åˆ©ç‡:{gross_margin or 0:>6.1f}% ç‡Ÿæ¥­åˆ©ç›Šç‡:{operating_margin or 0:>6.1f}% æ·¨åˆ©ç‡:{net_margin or 0:>6.1f}%")\n        \n    except Exception as e:\n        print(f"é¡¯ç¤ºç¯„ä¾‹è³‡æ–™å¤±æ•—: {e}")\n    finally:\n        conn.close()\n\ndef main():\n    """ä¸»å‡½æ•¸"""\n    # ç¢ºä¿ datetime åœ¨å‡½æ•¸ä½œç”¨åŸŸä¸­å¯ç”¨\n    from datetime import datetime as dt\n\n    parser = argparse.ArgumentParser(description='æ”¶é›†å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™')\n    parser.add_argument('--start-date', default='2020-01-01', help='é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)')\n    parser.add_argument('--end-date', default=dt.now().strftime('%Y-%m-%d'), help='çµæŸæ—¥æœŸ (YYYY-MM-DD)')\n    parser.add_argument('--batch-size', type=int, default=5, help='æ‰¹æ¬¡å¤§å°')\n    parser.add_argument('--test', action='store_true', help='æ¸¬è©¦æ¨¡å¼ (åªæ”¶é›†å‰5æª”è‚¡ç¥¨)')\n    parser.add_argument('--stock-id', help='æŒ‡å®šè‚¡ç¥¨ä»£ç¢¼')\n\n    args = parser.parse_args()\n\n    print("=" * 60)\n    if args.stock_id:\n        print(f"å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†ç³»çµ± - å€‹è‚¡ {args.stock_id}")\n    else:\n        print("å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†ç³»çµ±")\n    print("=" * 60)\n\n    # åˆå§‹åŒ–æ—¥èªŒ\n    init_logging()\n    logger.info("é–‹å§‹æ”¶é›†ç¶œåˆæç›Šè¡¨è³‡æ–™")\n\n    # ä¸å†é å…ˆåˆå§‹åŒ–è¨ˆæ™‚å™¨ï¼Œåªåœ¨é‡åˆ°APIé™åˆ¶æ™‚æ‰é–‹å§‹æª¢æŸ¥\n\n    try:\n        # ç²å–è‚¡ç¥¨æ¸…å–®\n        db_manager = DatabaseManager(Config.DATABASE_PATH)\n        conn = db_manager.get_connection()\n        cursor = conn.cursor()\n\n        if args.stock_id:\n            # æŒ‡å®šå€‹è‚¡\n            cursor.execute("""\n                SELECT stock_id, stock_name\n                FROM stocks\n                WHERE stock_id = ?\n            """, (args.stock_id,))\n            stock_list = [{'stock_id': row[0], 'stock_name': row[1]} for row in cursor.fetchall()]\n        else:\n            # åªé¸æ“‡çœŸæ­£çš„ä¸Šå¸‚å…¬å¸è‚¡ç¥¨ (4ä½æ•¸å­—è‚¡ç¥¨ä»£ç¢¼)\n            cursor.execute("""\n                SELECT stock_id, stock_name\n                FROM stocks\n                WHERE is_etf = 0\n                AND LENGTH(stock_id) = 4\n                AND stock_id GLOB '[0-9][0-9][0-9][0-9]'\n                AND market IN ('TWSE', 'TPEx')\n                ORDER BY stock_id\n            """)\n            stock_list = [{'stock_id': row[0], 'stock_name': row[1]} for row in cursor.fetchall()]\n\n        conn.close()\n\n        if args.test and not args.stock_id:\n            stock_list = stock_list[:5]\n            print(" æ¸¬è©¦æ¨¡å¼ï¼šåªæ”¶é›†å‰5æª”è‚¡ç¥¨")\n\n        if not stock_list:\n            if args.stock_id:\n                print(f" æ‰¾ä¸åˆ°è‚¡ç¥¨ä»£ç¢¼: {args.stock_id}")\n            else:\n                print(" æœªæ‰¾åˆ°è‚¡ç¥¨è³‡æ–™ï¼Œè«‹å…ˆåŸ·è¡Œè‚¡ç¥¨æ¸…å–®æ”¶é›†")\n            return\n        \n        # é–‹å§‹æ”¶é›†\n        total_saved, total_ratios, failed_stocks = collect_financial_statements_batch(\n            stock_list=stock_list,\n            start_date=args.start_date,\n            end_date=args.end_date,\n            batch_size=args.batch_size\n        )\n        \n        # é¡¯ç¤ºç¯„ä¾‹è³‡æ–™\n        if total_saved > 0:\n            show_sample_data(db_manager)\n        \n        logger.info(f"ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†å®Œæˆï¼Œå…±å„²å­˜ {total_saved} ç­†è³‡æ–™ï¼Œè¨ˆç®— {total_ratios} ç­†æ¯”ç‡")\n        \n    except Exception as e:\n        error_msg = f"ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†å¤±æ•—: {e}"\n        print(f" {error_msg}")\n        logger.error(error_msg)\n        sys.exit(1)\n\nif __name__ == "__main__":\n    main()\n