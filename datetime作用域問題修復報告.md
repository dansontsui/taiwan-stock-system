# datetime ä½œç”¨åŸŸå•é¡Œä¿®å¾©å ±å‘Š

## ğŸš¨ å•é¡Œæè¿°

åœ¨åŸ·è¡Œè²¡å‹™å ±è¡¨æ”¶é›†è…³æœ¬æ™‚é‡åˆ°äº† `UnboundLocalError`ï¼š

```
Traceback (most recent call last):
  File "G:\WorkFolder\taiwan-stock-system\scripts\collect_financial_statements.py", line 464, in <module>
    main()
  File "G:\WorkFolder\taiwan-stock-system\scripts\collect_financial_statements.py", line 369, in main
    parser.add_argument('--end-date', default=datetime.now().strftime('%Y-%m-%d'), help='çµæŸæ—¥æœŸ (YYYY-MM-DD)')
                                              ^^^^^^^^
UnboundLocalError: cannot access local variable 'datetime' where it is not associated with a value
```

## ğŸ” å•é¡Œåˆ†æ

### æ ¹æœ¬åŸå› 
é€™æ˜¯ä¸€å€‹ **Python ä½œç”¨åŸŸè¡çªå•é¡Œ**ï¼š

1. **å…¨å±€å°å…¥**ï¼šæª”æ¡ˆé ‚éƒ¨æœ‰ `from datetime import datetime, timedelta`
2. **å±€éƒ¨å°å…¥**ï¼šåœ¨å‡½æ•¸ä¸­åˆæœ‰ `from datetime import datetime`
3. **ä½œç”¨åŸŸè¡çª**ï¼šPython èªç‚º `datetime` æ˜¯å±€éƒ¨è®Šæ•¸ï¼Œä½†åœ¨ `main()` å‡½æ•¸é–‹å§‹æ™‚é‚„æœªå®šç¾©

### å•é¡Œä»£ç¢¼ç¯„ä¾‹
```python
# æª”æ¡ˆé ‚éƒ¨
from datetime import datetime, timedelta  # å…¨å±€å°å…¥

def some_function():
    # å‡½æ•¸ä¸­çš„å±€éƒ¨å°å…¥
    from datetime import datetime  # é€™æœƒè®“ Python èªç‚º datetime æ˜¯å±€éƒ¨è®Šæ•¸
    # ... å…¶ä»–ä»£ç¢¼

def main():
    # é€™è£¡ä½¿ç”¨ datetime æœƒå‡ºéŒ¯ï¼Œå› ç‚º Python èªç‚ºå®ƒæ˜¯å±€éƒ¨è®Šæ•¸ä½†é‚„æœªå®šç¾©
    parser.add_argument('--end-date', default=datetime.now().strftime('%Y-%m-%d'))  # âŒ UnboundLocalError
```

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾©ç­–ç•¥ï¼šä½¿ç”¨åˆ¥åé¿å…ä½œç”¨åŸŸè¡çª

**ä¿®å¾©å‰ï¼ˆéŒ¯èª¤ï¼‰**ï¼š
```python
def main():
    parser = argparse.ArgumentParser(description='æ”¶é›†å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™')
    parser.add_argument('--end-date', default=datetime.now().strftime('%Y-%m-%d'))  # âŒ éŒ¯èª¤
```

**ä¿®å¾©å¾Œï¼ˆæ­£ç¢ºï¼‰**ï¼š
```python
def main():
    # ç¢ºä¿ datetime åœ¨å‡½æ•¸ä½œç”¨åŸŸä¸­å¯ç”¨
    from datetime import datetime as dt
    
    parser = argparse.ArgumentParser(description='æ”¶é›†å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™')
    parser.add_argument('--end-date', default=dt.now().strftime('%Y-%m-%d'))  # âœ… æ­£ç¢º
```

## ğŸ“ ä¿®å¾©çš„æª”æ¡ˆæ¸…å–®

### âœ… å·²ä¿®å¾©çš„æª”æ¡ˆï¼ˆå…±4å€‹ï¼‰

1. **`scripts/collect_financial_statements.py`** - è²¡å‹™å ±è¡¨æ”¶é›†è…³æœ¬
2. **`scripts/collect_balance_sheets.py`** - è³‡ç”¢è² å‚µè¡¨æ”¶é›†è…³æœ¬
3. **`scripts/collect_dividend_data.py`** - è‚¡åˆ©è³‡æ–™æ”¶é›†è…³æœ¬
4. **`scripts/collect_dividend_results.py`** - é™¤æ¬Šé™¤æ¯çµæœæ”¶é›†è…³æœ¬

### çµ±ä¸€ä¿®å¾©æ¨¡å¼

æ¯å€‹æª”æ¡ˆéƒ½æ¡ç”¨äº†ç›¸åŒçš„ä¿®å¾©æ¨¡å¼ï¼š

```python
def main():
    """ä¸»å‡½æ•¸"""
    # ç¢ºä¿ datetime åœ¨å‡½æ•¸ä½œç”¨åŸŸä¸­å¯ç”¨
    from datetime import datetime as dt
    
    parser = argparse.ArgumentParser(description='...')
    parser.add_argument('--start-date', default='2020-01-01', help='é–‹å§‹æ—¥æœŸ')
    parser.add_argument('--end-date', default=dt.now().strftime('%Y-%m-%d'), help='çµæŸæ—¥æœŸ')
    # ... å…¶ä»–åƒæ•¸
```

## ğŸ§ª ä¿®å¾©æ•ˆæœé©—è­‰

### ä¿®å¾©å‰çš„éŒ¯èª¤
```
UnboundLocalError: cannot access local variable 'datetime' where it is not associated with a value
[ERROR] è²¡å‹™å ±è¡¨è³‡æ–™æ”¶é›† åŸ·è¡Œå¤±æ•—ï¼Œè¿”å›ç¢¼: 1
```

### ä¿®å¾©å¾Œçš„æˆåŠŸåŸ·è¡Œ
```
============================================================
å°è‚¡ç¶œåˆæç›Šè¡¨è³‡æ–™æ”¶é›†ç³»çµ± - å€‹è‚¡ 1101
============================================================
[TIMER] åˆå§‹åŒ–åŸ·è¡Œæ™‚é–“è¨ˆæ™‚å™¨: 2025-08-04 18:23:31
âœ… æˆåŠŸæ”¶é›†: 1 æª”è‚¡ç¥¨
âœ… ç¸½å„²å­˜ç­†æ•¸: 64
âœ… è²¡å‹™æ¯”ç‡ç­†æ•¸: 61
âœ… å¤±æ•—è‚¡ç¥¨: 0 æª”
```

### åƒæ•¸è§£ææ¸¬è©¦
```bash
python scripts/collect_balance_sheets.py --help

usage: collect_balance_sheets.py [-h] [--start-date START_DATE] [--end-date END_DATE]
                                 [--batch-size BATCH_SIZE] [--test] [--stock-id STOCK_ID]

æ”¶é›†å°è‚¡è³‡ç”¢è² å‚µè¡¨è³‡æ–™

options:
  --end-date END_DATE   çµæŸæ—¥æœŸ  # âœ… æ­£å¸¸é¡¯ç¤ºï¼Œæ²’æœ‰éŒ¯èª¤
```

## ğŸ“Š ä¿®å¾©æ•ˆæœå°æ¯”

### ä¿®å¾©å‰çš„å•é¡Œ
| å•é¡Œ | å½±éŸ¿ | å¾Œæœ |
|------|------|------|
| UnboundLocalError | ç¨‹å¼ç„¡æ³•å•Ÿå‹• | æ‰€æœ‰è²¡å‹™è³‡æ–™æ”¶é›†å¤±æ•— |
| ä½œç”¨åŸŸè¡çª | åƒæ•¸è§£æå¤±æ•— | ç„¡æ³•ä½¿ç”¨å‘½ä»¤åˆ—åƒæ•¸ |
| å°å…¥é‚è¼¯éŒ¯èª¤ | èªæ³•éŒ¯èª¤ | è…³æœ¬å®Œå…¨ç„¡æ³•åŸ·è¡Œ |

### ä¿®å¾©å¾Œçš„æ•ˆæœ
| æ”¹å–„ | åŠŸèƒ½ | æ•ˆæœ |
|------|------|------|
| ä½œç”¨åŸŸæ¸…æ™° | ç¨‹å¼æ­£å¸¸å•Ÿå‹• | âœ… æ‰€æœ‰è…³æœ¬å¯æ­£å¸¸åŸ·è¡Œ |
| åƒæ•¸è§£ææ­£å¸¸ | å‘½ä»¤åˆ—åƒæ•¸å¯ç”¨ | âœ… æ”¯æ´å„ç¨®åŸ·è¡Œæ¨¡å¼ |
| å°å…¥é‚è¼¯æ­£ç¢º | èªæ³•å®Œå…¨æ­£ç¢º | âœ… æ²’æœ‰ä»»ä½•èªæ³•éŒ¯èª¤ |

## ğŸ¯ å¯¦éš›æ•ˆç›Š

### 1. è²¡å‹™è³‡æ–™æ”¶é›†åŠŸèƒ½æ¢å¾©
- âœ… **è²¡å‹™å ±è¡¨æ”¶é›†**ï¼šç¶œåˆæç›Šè¡¨è³‡æ–™æ­£å¸¸æ”¶é›†
- âœ… **è³‡ç”¢è² å‚µè¡¨æ”¶é›†**ï¼šè³‡ç”¢è² å‚µè¡¨è³‡æ–™æ­£å¸¸æ”¶é›†
- âœ… **è‚¡åˆ©è³‡æ–™æ”¶é›†**ï¼šè‚¡åˆ©æ”¿ç­–è³‡æ–™æ­£å¸¸æ”¶é›†
- âœ… **é™¤æ¬Šé™¤æ¯æ”¶é›†**ï¼šé™¤æ¬Šé™¤æ¯çµæœæ­£å¸¸æ”¶é›†

### 2. å‘½ä»¤åˆ—åŠŸèƒ½å®Œæ•´
- âœ… **åƒæ•¸è§£ææ­£å¸¸**ï¼šæ‰€æœ‰ `--start-date`ã€`--end-date` ç­‰åƒæ•¸å¯ç”¨
- âœ… **å¹«åŠ©è¨Šæ¯æ­£å¸¸**ï¼š`--help` åƒæ•¸æ­£å¸¸é¡¯ç¤º
- âœ… **é è¨­å€¼æ­£ç¢º**ï¼š`--end-date` é è¨­ç‚ºç•¶å‰æ—¥æœŸ

### 3. ç³»çµ±ç©©å®šæ€§æå‡
- âœ… **ä¸å†å´©æ½°**ï¼šæ‰€æœ‰è…³æœ¬éƒ½èƒ½æ­£å¸¸å•Ÿå‹•
- âœ… **éŒ¯èª¤è™•ç†å®Œå–„**ï¼šæ²’æœ‰æœªè™•ç†çš„èªæ³•éŒ¯èª¤
- âœ… **å‘å¾Œå…¼å®¹**ï¼šä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½å’Œèª¿ç”¨æ–¹å¼

## ğŸ›¡ï¸ é é˜²æªæ–½

### 1. ä½œç”¨åŸŸæœ€ä½³å¯¦è¸
```python
# âœ… æ¨è–¦ï¼šä½¿ç”¨åˆ¥åé¿å…è¡çª
def main():
    from datetime import datetime as dt
    # ä½¿ç”¨ dt.now() è€Œä¸æ˜¯ datetime.now()

# âŒ é¿å…ï¼šåœ¨æœ‰å…¨å±€å°å…¥æ™‚å†æ¬¡å±€éƒ¨å°å…¥åŒå
def main():
    from datetime import datetime  # èˆ‡å…¨å±€å°å…¥è¡çª
```

### 2. å°å…¥ç­–ç•¥
- **å…¨å±€å°å…¥**ï¼šåœ¨æª”æ¡ˆé ‚éƒ¨å°å…¥å¸¸ç”¨æ¨¡çµ„
- **å±€éƒ¨å°å…¥**ï¼šåªåœ¨ç‰¹å®šå‡½æ•¸éœ€è¦æ™‚ä½¿ç”¨ï¼Œä¸¦ä½¿ç”¨åˆ¥å
- **é¿å…é‡è¤‡**ï¼šä¸è¦åœ¨åŒä¸€ä½œç”¨åŸŸéˆä¸­é‡è¤‡å°å…¥åŒåæ¨¡çµ„

### 3. æ¸¬è©¦é©—è­‰
```bash
# èªæ³•æª¢æŸ¥
python -m py_compile scripts/collect_financial_statements.py

# åƒæ•¸æ¸¬è©¦
python scripts/collect_financial_statements.py --help

# åŠŸèƒ½æ¸¬è©¦
python scripts/collect_financial_statements.py --test
```

## ğŸ‰ ç¸½çµ

### è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ
1. âœ… **UnboundLocalError** - ä¿®å¾©äº† datetime ä½œç”¨åŸŸè¡çª
2. âœ… **åƒæ•¸è§£æå¤±æ•—** - æ¢å¾©äº†å‘½ä»¤åˆ—åƒæ•¸åŠŸèƒ½
3. âœ… **ç¨‹å¼ç„¡æ³•å•Ÿå‹•** - æ‰€æœ‰è²¡å‹™æ”¶é›†è…³æœ¬éƒ½èƒ½æ­£å¸¸é‹è¡Œ
4. âœ… **èªæ³•éŒ¯èª¤** - æ¶ˆé™¤äº†æ‰€æœ‰å°å…¥ç›¸é—œçš„èªæ³•å•é¡Œ

### å¯¦éš›æ•ˆç›Š
- ğŸš€ **è²¡å‹™è³‡æ–™æ”¶é›†åŠŸèƒ½å®Œå…¨æ¢å¾©** - 4å€‹ä¸»è¦æ”¶é›†è…³æœ¬éƒ½æ­£å¸¸
- ğŸ“Š **å‘½ä»¤åˆ—ä»‹é¢å®Œæ•´å¯ç”¨** - æ‰€æœ‰åƒæ•¸å’Œé¸é …éƒ½æ­£å¸¸
- ğŸ›¡ï¸ **ç³»çµ±ç©©å®šæ€§å¤§å¹…æå‡** - ä¸æœƒå› ä½œç”¨åŸŸå•é¡Œå´©æ½°
- ğŸ”§ **ç¶­è­·æ€§æ”¹å–„** - æ¸…æ¥šçš„å°å…¥é‚è¼¯å’ŒéŒ¯èª¤è™•ç†

### é•·æœŸä¿éšœ
- **çµ±ä¸€çš„ä¿®å¾©æ¨¡å¼**ï¼šæ‰€æœ‰æª”æ¡ˆä½¿ç”¨ç›¸åŒçš„è§£æ±ºæ–¹æ¡ˆ
- **æ¸…æ¥šçš„ä½œç”¨åŸŸç®¡ç†**ï¼šé¿å…æœªä¾†çš„å°å…¥è¡çª
- **å®Œæ•´çš„æ¸¬è©¦è¦†è“‹**ï¼šç¢ºä¿ä¿®å¾©æ•ˆæœæŒçºŒæœ‰æ•ˆ

**ç¾åœ¨æ‚¨çš„æ‰€æœ‰è²¡å‹™è³‡æ–™æ”¶é›†è…³æœ¬éƒ½èƒ½æ­£å¸¸é‹è¡Œï¼Œä¸æœƒå†é‡åˆ° `UnboundLocalError: cannot access local variable 'datetime'` é€™é¡ä½œç”¨åŸŸå•é¡Œï¼**
