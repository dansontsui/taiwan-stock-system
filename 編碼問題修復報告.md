# ç·¨ç¢¼å•é¡Œä¿®å¾©å ±å‘Š

## ğŸš¨ å•é¡Œæè¿°

åœ¨åŸ·è¡Œ subprocess ç›¸é—œæ“ä½œæ™‚é‡åˆ°äº†ç·¨ç¢¼éŒ¯èª¤ï¼š

```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x8c in position 66: illegal multibyte sequence
```

### ğŸ” å•é¡Œåˆ†æ

**æ ¹æœ¬åŸå› **ï¼šWindows ç³»çµ±é è¨­ä½¿ç”¨ cp950 ç·¨ç¢¼ï¼Œä½†ç¨‹å¼è¼¸å‡ºåŒ…å« UTF-8 å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ã€ç‰¹æ®Šç¬¦è™Ÿï¼‰ï¼Œå°è‡´ç·¨ç¢¼è¡çªã€‚

**å…·é«”å•é¡Œ**ï¼š
1. `subprocess.run()` å’Œ `subprocess.Popen()` æ²’æœ‰æŒ‡å®šç·¨ç¢¼åƒæ•¸
2. ç³»çµ±é è¨­ä½¿ç”¨ cp950 ç·¨ç¢¼è®€å– UTF-8 è¼¸å‡º
3. é‡åˆ°ç„¡æ³•è§£ç¢¼çš„å­—ç¯€æ™‚æ‹‹å‡º `UnicodeDecodeError`

**éŒ¯èª¤å ´æ™¯**ï¼š
- ç¨‹å¼è¼¸å‡ºåŒ…å«ä¸­æ–‡å­—ç¬¦ï¼š`âœ…âŒâš ï¸ğŸ”§`
- æ—¥èªŒè¨Šæ¯åŒ…å«ç‰¹æ®Šç¬¦è™Ÿ
- é€²åº¦é¡¯ç¤ºåŒ…å« Unicode å­—ç¬¦

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. è‡ªå‹•åŒ–ä¿®å¾©å·¥å…·

å‰µå»ºäº† `fix_encoding_issues.py` è‡ªå‹•ä¿®å¾©å·¥å…·ï¼Œèƒ½å¤ ï¼š

#### ä¿®å¾©æ¨¡å¼1ï¼šåŸºæœ¬ subprocess.run
```python
# ä¿®å¾©å‰
subprocess.run(cmd, text=True)

# ä¿®å¾©å¾Œ
subprocess.run(cmd, text=True, encoding="utf-8", errors="replace")
```

#### ä¿®å¾©æ¨¡å¼2ï¼šcapture_output subprocess.run
```python
# ä¿®å¾©å‰
subprocess.run(cmd, capture_output=True, text=True)

# ä¿®å¾©å¾Œ
subprocess.run(cmd, capture_output=True, text=True, encoding="utf-8", errors="replace")
```

#### ä¿®å¾©æ¨¡å¼3ï¼šsubprocess.Popen
```python
# ä¿®å¾©å‰
subprocess.Popen(cmd, text=True)

# ä¿®å¾©å¾Œ
subprocess.Popen(cmd, text=True, encoding="utf-8", errors="replace")
```

#### ä¿®å¾©æ¨¡å¼4ï¼šuniversal_newlines
```python
# ä¿®å¾©å‰
subprocess.Popen(cmd, universal_newlines=True)

# ä¿®å¾©å¾Œ
subprocess.Popen(cmd, universal_newlines=True, encoding="utf-8", errors="replace")
```

### 2. ç·¨ç¢¼è¼”åŠ©æ¨¡çµ„

å‰µå»ºäº† `scripts/encoding_helper.py` æä¾›å®‰å…¨çš„ subprocess å‡½æ•¸ï¼š

```python
from scripts.encoding_helper import safe_subprocess_run, safe_subprocess_popen

# è‡ªå‹•è™•ç†ç·¨ç¢¼çš„å®‰å…¨å‡½æ•¸
result = safe_subprocess_run(cmd, text=True)
process = safe_subprocess_popen(cmd, text=True)
```

## ğŸ“Š ä¿®å¾©çµæœ

### æƒæçµ±è¨ˆ
- **æª¢æŸ¥æª”æ¡ˆæ•¸**: 160 å€‹ Python æª”æ¡ˆ
- **ä¿®å¾©æª”æ¡ˆæ•¸**: 5 å€‹æª”æ¡ˆ
- **ç¸½ä¿®å¾©é …ç›®**: 7 å€‹ç·¨ç¢¼å•é¡Œ

### âœ… å·²ä¿®å¾©çš„æª”æ¡ˆæ¸…å–®

1. **`c.py`** - ä¸»æ”¶é›†è…³æœ¬
   - ä¿®å¾© `subprocess.run(cmd, check=True)` ç·¨ç¢¼å•é¡Œ

2. **`fix_encoding_issues.py`** - ä¿®å¾©å·¥å…·æœ¬èº«
   - æ·»åŠ ç·¨ç¢¼åƒæ•¸åˆ°å¤šå€‹ subprocess èª¿ç”¨

3. **`potential_stock_predictor/menu.py`** - é æ¸¬ç³»çµ±é¸å–®
   - ä¿®å¾©é¸å–®åŸ·è¡Œå‘½ä»¤çš„ç·¨ç¢¼å•é¡Œ

4. **`potential_stock_predictor/simple_menu.py`** - ç°¡åŒ–é¸å–®
   - ä¿®å¾© subprocess.run ç·¨ç¢¼åƒæ•¸

5. **`çµ‚ç«¯æ©Ÿå•Ÿå‹•.py`** - çµ‚ç«¯æ©Ÿå•Ÿå‹•è…³æœ¬
   - ä¿®å¾©ç•°æ­¥å’ŒåŒæ­¥åŸ·è¡Œçš„ç·¨ç¢¼å•é¡Œ

### ğŸ§ª æ¸¬è©¦é©—è­‰çµæœ

```
ğŸ§ª æ¸¬è©¦ç·¨ç¢¼ä¿®å¾©æ•ˆæœ
----------------------------------------
âœ… åŸºæœ¬ä¸­æ–‡è¼¸å‡ºæ¸¬è©¦é€šé
âœ… ç‰¹æ®Šå­—ç¬¦è¼¸å‡ºæ¸¬è©¦é€šé
âœ… æ‰€æœ‰ç·¨ç¢¼æ¸¬è©¦é€šé
```

## ğŸ›¡ï¸ ç·¨ç¢¼åƒæ•¸èªªæ˜

### encoding='utf-8'
- **ä½œç”¨**ï¼šæŒ‡å®šä½¿ç”¨ UTF-8 ç·¨ç¢¼è®€å–ç¨‹å¼è¼¸å‡º
- **æ•ˆæœ**ï¼šæ­£ç¢ºè™•ç†ä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
- **é©ç”¨**ï¼šæ‰€æœ‰åŒ…å«ä¸­æ–‡è¼¸å‡ºçš„ç¨‹å¼

### errors='replace'
- **ä½œç”¨**ï¼šé‡åˆ°ç„¡æ³•è§£ç¢¼çš„å­—ç¯€æ™‚ç”¨æ›¿ä»£å­—ç¬¦ä»£æ›¿
- **æ•ˆæœ**ï¼šé¿å…ç¨‹å¼å´©æ½°ï¼Œç¹¼çºŒåŸ·è¡Œ
- **é©ç”¨**ï¼šä¸ç¢ºå®šè¼¸å‡ºç·¨ç¢¼çš„æƒ…æ³

### çµ„åˆæ•ˆæœ
```python
subprocess.run(cmd, text=True, encoding='utf-8', errors='replace')
```
- âœ… æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡å­—ç¬¦
- âœ… æ­£ç¢ºé¡¯ç¤ºç‰¹æ®Šç¬¦è™Ÿ `âœ…âŒâš ï¸ğŸ”§`
- âœ… é‡åˆ°ç·¨ç¢¼å•é¡Œæ™‚ä¸æœƒå´©æ½°
- âœ… ä¿æŒç¨‹å¼ç©©å®šé‹è¡Œ

## ğŸ¯ å¯¦éš›æ•ˆç›Š

### 1. è§£æ±ºç·¨ç¢¼å´©æ½°å•é¡Œ
**ä¿®å¾©å‰**ï¼š
```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x8c
ç¨‹å¼å´©æ½°ï¼Œç„¡æ³•ç¹¼çºŒåŸ·è¡Œ
```

**ä¿®å¾©å¾Œ**ï¼š
```
âœ… æ­£å¸¸é¡¯ç¤ºä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
âœ… ç¨‹å¼ç©©å®šé‹è¡Œï¼Œä¸æœƒå› ç·¨ç¢¼å•é¡Œå´©æ½°
```

### 2. æ”¹å–„ç”¨æˆ¶é«”é©—
- âœ… **æ­£ç¢ºçš„ä¸­æ–‡é¡¯ç¤º**ï¼šé€²åº¦è¨Šæ¯ã€éŒ¯èª¤è¨Šæ¯æ­£å¸¸é¡¯ç¤º
- âœ… **ç‰¹æ®Šç¬¦è™Ÿæ”¯æ´**ï¼š`âœ…âŒâš ï¸ğŸ”§` ç­‰ç¬¦è™Ÿæ­£å¸¸é¡¯ç¤º
- âœ… **ç©©å®šçš„ç¨‹å¼åŸ·è¡Œ**ï¼šä¸æœƒå› ç·¨ç¢¼å•é¡Œä¸­æ–·

### 3. ç³»çµ±å…¼å®¹æ€§æå‡
- âœ… **Windows å…¼å®¹**ï¼šè§£æ±º cp950 ç·¨ç¢¼è¡çª
- âœ… **è·¨å¹³å°æ”¯æ´**ï¼šUTF-8 åœ¨å„å¹³å°é€šç”¨
- âœ… **å‘å¾Œå…¼å®¹**ï¼šä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½

## ğŸ”§ é é˜²æªæ–½

### 1. æ¨™æº–åŒ–ç·¨ç¢¼è™•ç†
å»ºè­°æ‰€æœ‰æ–°çš„ subprocess èª¿ç”¨éƒ½ä½¿ç”¨ï¼š
```python
# æ¨™æº–æ¨¡å¼
subprocess.run(cmd, text=True, encoding='utf-8', errors='replace')
subprocess.Popen(cmd, text=True, encoding='utf-8', errors='replace')
```

### 2. ä½¿ç”¨ç·¨ç¢¼è¼”åŠ©æ¨¡çµ„
```python
# å°å…¥å®‰å…¨å‡½æ•¸
from scripts.encoding_helper import safe_subprocess_run, safe_subprocess_popen

# è‡ªå‹•è™•ç†ç·¨ç¢¼
result = safe_subprocess_run(cmd, text=True)
process = safe_subprocess_popen(cmd, text=True)
```

### 3. ç’°å¢ƒè®Šæ•¸è¨­ç½®
åœ¨ç¨‹å¼é–‹å§‹æ™‚è¨­ç½®ï¼š
```python
import os
os.environ['PYTHONIOENCODING'] = 'utf-8'
```

## ğŸ“‹ ä½¿ç”¨æŒ‡å—

### æª¢æŸ¥ç·¨ç¢¼å•é¡Œ
```bash
# åŸ·è¡Œä¿®å¾©å·¥å…·
python fix_encoding_issues.py

# æª¢æŸ¥ç‰¹å®šæª”æ¡ˆ
grep -r "subprocess\." --include="*.py" . | grep -v "encoding="
```

### æ¸¬è©¦ç·¨ç¢¼ä¿®å¾©
```bash
# æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
python c.py stock-by-stock-test

# æ¸¬è©¦ä¸­æ–‡è¼¸å‡º
python simple_collect.py --test

# æ¸¬è©¦ç‰¹æ®Šå­—ç¬¦
python scripts/progress_tool.py list
```

### æ‰‹å‹•ä¿®å¾©ç¯„ä¾‹
å¦‚æœç™¼ç¾æ–°çš„ç·¨ç¢¼å•é¡Œï¼š
```python
# ä¿®å¾©å‰
result = subprocess.run(cmd, capture_output=True, text=True)

# ä¿®å¾©å¾Œ
result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8', errors='replace')
```

## ğŸ‰ ç¸½çµ

### è§£æ±ºçš„æ ¸å¿ƒå•é¡Œ
1. âœ… **UnicodeDecodeError** - ä¿®å¾©äº† cp950 ç·¨ç¢¼è¡çª
2. âœ… **ç¨‹å¼å´©æ½°** - é¿å…å› ç·¨ç¢¼å•é¡Œå°è‡´çš„ç¨‹å¼ä¸­æ–·
3. âœ… **å­—ç¬¦é¡¯ç¤º** - æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡å’Œç‰¹æ®Šç¬¦è™Ÿ
4. âœ… **ç³»çµ±ç©©å®šæ€§** - æå‡æ•´é«”ç³»çµ±çš„ç©©å®šæ€§

### å¯¦éš›æ•ˆç›Š
- ğŸš€ **ç¨‹å¼ç©©å®šæ€§å¤§å¹…æå‡** - ä¸å†å› ç·¨ç¢¼å•é¡Œå´©æ½°
- ğŸ“Š **æ­£ç¢ºçš„è¨Šæ¯é¡¯ç¤º** - ä¸­æ–‡å’Œç‰¹æ®Šç¬¦è™Ÿæ­£å¸¸é¡¯ç¤º
- ğŸ›¡ï¸ **éŒ¯èª¤å®¹å¿èƒ½åŠ›** - é‡åˆ°ç·¨ç¢¼å•é¡Œæ™‚å„ªé›…è™•ç†
- ğŸ”§ **ç¶­è­·æ€§æå‡** - æä¾›å®Œæ•´çš„ä¿®å¾©å·¥å…·å’Œè¼”åŠ©æ¨¡çµ„

### é•·æœŸä¿éšœ
- **è‡ªå‹•åŒ–ä¿®å¾©å·¥å…·**ï¼š`fix_encoding_issues.py` å¯é‡è¤‡ä½¿ç”¨
- **ç·¨ç¢¼è¼”åŠ©æ¨¡çµ„**ï¼š`scripts/encoding_helper.py` æä¾›å®‰å…¨å‡½æ•¸
- **æ¨™æº–åŒ–è™•ç†**ï¼šçµ±ä¸€çš„ç·¨ç¢¼è™•ç†æ¨¡å¼
- **å®Œæ•´æ¸¬è©¦**ï¼šé©—è­‰ä¿®å¾©æ•ˆæœçš„æ¸¬è©¦æ©Ÿåˆ¶

**ç¾åœ¨æ‚¨çš„ç³»çµ±å·²ç¶“å…·å‚™äº†å®Œæ•´çš„ç·¨ç¢¼ä¿è­·æ©Ÿåˆ¶ï¼Œä¸æœƒå†é‡åˆ° `UnicodeDecodeError: 'cp950' codec can't decode byte` é€™é¡ç·¨ç¢¼å•é¡Œï¼**
