# 編碼問題修復報告

## 🚨 問題描述

在執行 subprocess 相關操作時遇到了編碼錯誤：

```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x8c in position 66: illegal multibyte sequence
```

### 🔍 問題分析

**根本原因**：Windows 系統預設使用 cp950 編碼，但程式輸出包含 UTF-8 字符（如中文、特殊符號），導致編碼衝突。

**具體問題**：
1. `subprocess.run()` 和 `subprocess.Popen()` 沒有指定編碼參數
2. 系統預設使用 cp950 編碼讀取 UTF-8 輸出
3. 遇到無法解碼的字節時拋出 `UnicodeDecodeError`

**錯誤場景**：
- 程式輸出包含中文字符：`✅❌⚠️🔧`
- 日誌訊息包含特殊符號
- 進度顯示包含 Unicode 字符

## ✅ 修復方案

### 1. 自動化修復工具

創建了 `fix_encoding_issues.py` 自動修復工具，能夠：

#### 修復模式1：基本 subprocess.run
```python
# 修復前
subprocess.run(cmd, text=True)

# 修復後
subprocess.run(cmd, text=True, encoding="utf-8", errors="replace")
```

#### 修復模式2：capture_output subprocess.run
```python
# 修復前
subprocess.run(cmd, capture_output=True, text=True)

# 修復後
subprocess.run(cmd, capture_output=True, text=True, encoding="utf-8", errors="replace")
```

#### 修復模式3：subprocess.Popen
```python
# 修復前
subprocess.Popen(cmd, text=True)

# 修復後
subprocess.Popen(cmd, text=True, encoding="utf-8", errors="replace")
```

#### 修復模式4：universal_newlines
```python
# 修復前
subprocess.Popen(cmd, universal_newlines=True)

# 修復後
subprocess.Popen(cmd, universal_newlines=True, encoding="utf-8", errors="replace")
```

### 2. 編碼輔助模組

創建了 `scripts/encoding_helper.py` 提供安全的 subprocess 函數：

```python
from scripts.encoding_helper import safe_subprocess_run, safe_subprocess_popen

# 自動處理編碼的安全函數
result = safe_subprocess_run(cmd, text=True)
process = safe_subprocess_popen(cmd, text=True)
```

## 📊 修復結果

### 掃描統計
- **檢查檔案數**: 160 個 Python 檔案
- **修復檔案數**: 5 個檔案
- **總修復項目**: 7 個編碼問題

### ✅ 已修復的檔案清單

1. **`c.py`** - 主收集腳本
   - 修復 `subprocess.run(cmd, check=True)` 編碼問題

2. **`fix_encoding_issues.py`** - 修復工具本身
   - 添加編碼參數到多個 subprocess 調用

3. **`potential_stock_predictor/menu.py`** - 預測系統選單
   - 修復選單執行命令的編碼問題

4. **`potential_stock_predictor/simple_menu.py`** - 簡化選單
   - 修復 subprocess.run 編碼參數

5. **`終端機啟動.py`** - 終端機啟動腳本
   - 修復異步和同步執行的編碼問題

### 🧪 測試驗證結果

```
🧪 測試編碼修復效果
----------------------------------------
✅ 基本中文輸出測試通過
✅ 特殊字符輸出測試通過
✅ 所有編碼測試通過
```

## 🛡️ 編碼參數說明

### encoding='utf-8'
- **作用**：指定使用 UTF-8 編碼讀取程式輸出
- **效果**：正確處理中文和特殊字符
- **適用**：所有包含中文輸出的程式

### errors='replace'
- **作用**：遇到無法解碼的字節時用替代字符代替
- **效果**：避免程式崩潰，繼續執行
- **適用**：不確定輸出編碼的情況

### 組合效果
```python
subprocess.run(cmd, text=True, encoding='utf-8', errors='replace')
```
- ✅ 正確顯示中文字符
- ✅ 正確顯示特殊符號 `✅❌⚠️🔧`
- ✅ 遇到編碼問題時不會崩潰
- ✅ 保持程式穩定運行

## 🎯 實際效益

### 1. 解決編碼崩潰問題
**修復前**：
```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x8c
程式崩潰，無法繼續執行
```

**修復後**：
```
✅ 正常顯示中文和特殊字符
✅ 程式穩定運行，不會因編碼問題崩潰
```

### 2. 改善用戶體驗
- ✅ **正確的中文顯示**：進度訊息、錯誤訊息正常顯示
- ✅ **特殊符號支援**：`✅❌⚠️🔧` 等符號正常顯示
- ✅ **穩定的程式執行**：不會因編碼問題中斷

### 3. 系統兼容性提升
- ✅ **Windows 兼容**：解決 cp950 編碼衝突
- ✅ **跨平台支援**：UTF-8 在各平台通用
- ✅ **向後兼容**：不影響現有功能

## 🔧 預防措施

### 1. 標準化編碼處理
建議所有新的 subprocess 調用都使用：
```python
# 標準模式
subprocess.run(cmd, text=True, encoding='utf-8', errors='replace')
subprocess.Popen(cmd, text=True, encoding='utf-8', errors='replace')
```

### 2. 使用編碼輔助模組
```python
# 導入安全函數
from scripts.encoding_helper import safe_subprocess_run, safe_subprocess_popen

# 自動處理編碼
result = safe_subprocess_run(cmd, text=True)
process = safe_subprocess_popen(cmd, text=True)
```

### 3. 環境變數設置
在程式開始時設置：
```python
import os
os.environ['PYTHONIOENCODING'] = 'utf-8'
```

## 📋 使用指南

### 檢查編碼問題
```bash
# 執行修復工具
python fix_encoding_issues.py

# 檢查特定檔案
grep -r "subprocess\." --include="*.py" . | grep -v "encoding="
```

### 測試編碼修復
```bash
# 測試基本功能
python c.py stock-by-stock-test

# 測試中文輸出
python simple_collect.py --test

# 測試特殊字符
python scripts/progress_tool.py list
```

### 手動修復範例
如果發現新的編碼問題：
```python
# 修復前
result = subprocess.run(cmd, capture_output=True, text=True)

# 修復後
result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8', errors='replace')
```

## 🎉 總結

### 解決的核心問題
1. ✅ **UnicodeDecodeError** - 修復了 cp950 編碼衝突
2. ✅ **程式崩潰** - 避免因編碼問題導致的程式中斷
3. ✅ **字符顯示** - 正確顯示中文和特殊符號
4. ✅ **系統穩定性** - 提升整體系統的穩定性

### 實際效益
- 🚀 **程式穩定性大幅提升** - 不再因編碼問題崩潰
- 📊 **正確的訊息顯示** - 中文和特殊符號正常顯示
- 🛡️ **錯誤容忍能力** - 遇到編碼問題時優雅處理
- 🔧 **維護性提升** - 提供完整的修復工具和輔助模組

### 長期保障
- **自動化修復工具**：`fix_encoding_issues.py` 可重複使用
- **編碼輔助模組**：`scripts/encoding_helper.py` 提供安全函數
- **標準化處理**：統一的編碼處理模式
- **完整測試**：驗證修復效果的測試機制

**現在您的系統已經具備了完整的編碼保護機制，不會再遇到 `UnicodeDecodeError: 'cp950' codec can't decode byte` 這類編碼問題！**
