# 台股資料收集系統 - 斷點續傳功能使用說明

## 📋 功能概述

本系統新增了完整的斷點續傳功能，讓資料收集任務在中斷後能夠從上次停止的地方繼續執行，大幅提升長時間運行任務的穩定性和效率。

### 🎯 主要特色

1. **智能進度記錄**：自動記錄每檔股票的收集進度和狀態
2. **多層級斷點續傳**：支援任務級別和股票級別的續傳
3. **詳細狀態追蹤**：記錄成功、失敗、部分完成等多種狀態
4. **跨平台兼容**：支援 Windows 和 macOS 系統
5. **完整的管理工具**：提供進度查看、重置、清理等功能

## 🏗️ 系統架構

### 核心組件

```
scripts/
├── progress_manager.py      # 進度管理器核心類別
├── progress_tool.py         # 進度管理命令行工具
├── collect_with_resume.py   # 支援斷點續傳的批次收集腳本
└── smart_wait.py           # 智能等待模組（API限制處理）

data/
└── progress/               # 進度記錄目錄
    ├── collection_progress.json  # 主要進度檔案
    └── backups/            # 進度檔案備份
```

### 進度記錄結構

```json
{
  "tasks": {
    "task_id": {
      "task_id": "comprehensive_20250804_154826",
      "task_type": "comprehensive",
      "task_name": "測試收集_20250804_154826",
      "status": "completed",
      "total_stocks": 3,
      "completed_stocks": 3,
      "failed_stocks": 0,
      "start_time": "2025-08-04T15:48:26",
      "stock_progress": {
        "2330": {
          "stock_id": "2330",
          "stock_name": "台積電",
          "status": "completed",
          "completed_datasets": ["TaiwanStockPrice", "TaiwanStockMonthRevenue"],
          "failed_datasets": [],
          "retry_count": 0
        }
      }
    }
  }
}
```

## 🚀 使用方法

### 1. 基本資料收集（支援斷點續傳）

#### 簡化版收集腳本
```bash
# 開始新的測試收集
python simple_collect.py --test

# 開始新的完整收集
python simple_collect.py --start-date 2020-01-01 --end-date 2025-12-31

# 收集特定股票
python simple_collect.py --stock-id 2330

# 查看所有任務
python simple_collect.py --list-tasks

# 續傳中斷的任務
python simple_collect.py --resume-task <task_id>
```

#### 批次收集腳本
```bash
# 開始新的測試收集
python scripts/collect_with_resume.py --test

# 開始新的批次收集
python scripts/collect_with_resume.py --start-date 2020-01-01 --end-date 2025-12-31 --batch-size 50

# 查看所有任務
python scripts/collect_with_resume.py --list-tasks

# 續傳中斷的任務
python scripts/collect_with_resume.py --resume-task <task_id>
```

### 2. 進度管理工具

#### 查看任務清單
```bash
python scripts/progress_tool.py list
```

#### 查看任務詳細資訊
```bash
python scripts/progress_tool.py show --task-id <task_id>
```

#### 查看待處理股票
```bash
python scripts/progress_tool.py pending --task-id <task_id>
```

#### 重置任務進度
```bash
python scripts/progress_tool.py reset --task-id <task_id>
```

#### 刪除任務記錄
```bash
python scripts/progress_tool.py delete --task-id <task_id>
```

#### 清理已完成任務
```bash
python scripts/progress_tool.py clean
```

## 📊 任務狀態說明

### 任務狀態
- `not_started`：未開始
- `in_progress`：進行中
- `completed`：已完成
- `failed`：失敗

### 股票狀態
- `not_started`：未開始處理
- `in_progress`：正在處理（部分資料集完成）
- `completed`：所有資料集收集完成
- `failed`：所有資料集收集失敗
- `skipped`：跳過處理

## 🔧 斷點續傳機制

### 自動續傳流程

1. **任務創建**：系統自動為每個收集任務創建唯一ID和進度記錄
2. **進度追蹤**：實時記錄每檔股票的每個資料集收集狀態
3. **中斷檢測**：程式重啟時自動檢測未完成的任務
4. **智能續傳**：只處理未完成或失敗的股票，跳過已成功的部分
5. **狀態更新**：持續更新進度直到任務完成

### 續傳策略

#### 股票級別續傳
- 已完成的股票：直接跳過
- 部分完成的股票：繼續收集剩餘資料集
- 失敗的股票：重新嘗試收集
- 未開始的股票：正常收集

#### 資料集級別續傳
- 已成功的資料集：跳過
- 失敗的資料集：重新收集
- 未處理的資料集：正常收集

## 🛠️ 故障處理

### 常見問題

#### 1. API請求限制
**現象**：收到402錯誤或API限制訊息
**處理**：系統自動觸發智能等待機制，等待API重置後繼續

#### 2. 網路連線中斷
**現象**：連線超時或網路錯誤
**處理**：記錄失敗狀態，重啟後可續傳失敗的股票

#### 3. 程式意外中斷
**現象**：程式崩潰或被強制關閉
**處理**：重啟後使用 `--resume-task` 參數繼續未完成的任務

#### 4. 資料庫鎖定
**現象**：SQLite資料庫被鎖定
**處理**：等待鎖定釋放或重啟程式後續傳

### 手動恢復步驟

1. **查看任務狀態**
   ```bash
   python scripts/progress_tool.py list
   ```

2. **檢查具體任務詳情**
   ```bash
   python scripts/progress_tool.py show --task-id <task_id>
   ```

3. **續傳未完成任務**
   ```bash
   python simple_collect.py --resume-task <task_id>
   ```

4. **如果任務狀態異常，重置後重新開始**
   ```bash
   python scripts/progress_tool.py reset --task-id <task_id>
   python simple_collect.py --resume-task <task_id>
   ```

## 📈 效能優化建議

### 1. 批次大小調整
- 小批次（10-20檔）：適合測試和不穩定網路環境
- 中批次（50-100檔）：平衡效能和穩定性
- 大批次（200+檔）：適合穩定環境和大量資料收集

### 2. 時間範圍設定
- 避免過長的時間範圍（超過10年）
- 分段收集大量歷史資料
- 定期進行增量更新

### 3. 系統資源管理
- 監控記憶體使用量
- 定期清理已完成的任務記錄
- 備份重要的進度檔案

## 🧪 測試驗證

### 執行完整測試
```bash
python test_resume_functionality.py
```

### 測試內容
1. **進度管理器基本功能測試**
2. **斷點續傳場景模擬測試**
3. **與資料收集系統整合測試**

## 📝 最佳實踐

### 1. 任務規劃
- 合理設定批次大小和時間範圍
- 避免同時運行多個大型收集任務
- 定期檢查和清理進度記錄

### 2. 監控管理
- 定期查看任務進度和狀態
- 及時處理失敗的任務
- 保持進度檔案的備份

### 3. 故障預防
- 確保網路連線穩定
- 監控API使用量和限制
- 定期更新和維護系統

## 🔮 未來擴展

### 計劃功能
1. **Web介面管理**：提供圖形化的進度管理介面
2. **自動重試機制**：智能重試失敗的任務
3. **並行處理**：支援多執行緒並行收集
4. **通知系統**：任務完成或失敗時發送通知
5. **效能監控**：詳細的效能指標和報告

### 擴展建議
- 整合到現有的排程系統
- 添加更多的資料來源支援
- 實現分散式收集架構

---

## 📞 技術支援

如有問題或建議，請參考：
1. 執行測試腳本進行故障診斷
2. 查看進度管理工具的詳細輸出
3. 檢查系統日誌和錯誤訊息

**🎉 享受更穩定、更高效的資料收集體驗！**
